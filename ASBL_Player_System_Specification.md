# ASBL 籃球遊戲球員系統規格書 (v3.3)

**版本**：3.3
**文件類型**：核心邏輯規格 (Core Logic Specification)
**狀態**：已定案 (Confirmed)
**最後更新**：2025-12-28
**變更記錄**：
*   **v1.0 (2025-12-03)**：初始版本，定義生成、成長、老化邏輯。
*   **v2.0 (2025-12-03)**：
    *   **移除**：體重 (Weight) 生成系統。
    *   **修改**：可訓練能力生成邏輯，由「壓縮機制」改為「重骰機制 (Reroll)」，允許極端偏科數值出現。
*   **v2.1 (2025-12-03)**：
    *   **修正**：移除薪資公式中的 `* 100` 倍率。
    *   **格式**：將數學公式改為純文字格式以便閱讀。
*   **v2.2 (2025-12-03)**：
    *   **修改**：姓名生成邏輯，針對「姓氏」設定長度機率 (80/15/5)。
    *   **新增**：定義開隊陣容檢核標準 (C>=2, PG>=2, G>=4, F>=4)。
*   **v2.4 (2025-12-04)**：
    *   **新增**：球員初始年齡生成規則 (SSR 固定 18 歲，隨等級下降範圍擴大)。
    *   **新增**：初始合約規則 (年限與角色定位與等級掛鉤)。
*   **v2.5 (2025-12-04)**：
    *   **新增**：第 6 章「上場時間分配系統 (Minutes Distribution System)」。
    *   **定義**：各角色定位 (Role) 的保底時間與權重浮動範圍。
    *   **演算法**：定義基於權重的動態時間分配公式。
*   **v2.6 (2025-12-11)**：
    *   **新增**：球員屬性的欄位定義。
    *   **用途**：確保後續設計程式時能保持一致性。
*   **v3.1 (2025-12-22)**：
    *   **重構**：重新定義球員生成流程順序 (姓名 -> 等級 -> 天賦 -> 身高 -> 位置 -> 能力 -> 年齡)。
    *   **恢復**：加回 `2.3.1` 天賦 (Untrainable) 的詳細數值區間定義 (Sum/Stat Range)。
    *   **新增**：`2.4.2` 可訓練能力 (Trainable) 的 **位置檢核機制 (Position Validation)**。
    *   **新增**：`2.4.3` 可訓練能力 (Trainable) 的 **身高修正機制 (Height Modifier)**，包含補償 (Bonus) 與懲罰 (Penalty) 邏輯。
*   **v3.2 (2025-12-24)**：
    *   **新增**：`5.4` 開隊球員特殊生成規則 (Initial Roster Rules)，定義僅在開隊時套用 **50% 能力下限**，以縮小初始隨機範圍。
*   **v3.3 (2025-12-28)**：
    *   **新增**：`5.2` 位置檢核條件新增高階位置覆蓋。

---

## 1. 系統概述
本文件定義了 ASBL (Advanced Simulation Basketball League) 中球員生成、能力值分配、成長與老化機制的核心邏輯。設計目標是創造一個具備高度策略性、隨機性與經營深度的籃球模擬環境。

---

## 2. 球員生成系統 (Player Generation)

### 2.0 球員生成流程 (Player Generation Workflow)
本章節描述單一球員生成的標準作業程序 (SOP)，程式實作需嚴格遵守此順序，因為後續步驟依賴前序步驟的產出。

**執行順序**：
1.  **決定姓名** (Name)
2.  **決定等級** (Grade)
3.  **生成天賦** (Untrainable Stats - 依據等級)
4.  **決定身高** (Height)
5.  **決定位置** (Position - 依據身高)
6.  **生成能力** (Trainable Stats - 依據等級、位置、身高)
7.  **生成年齡** (Age - 依據等級)

---

### 2.1 姓名生成 (Name Generation)
*   **資料來源**：`NameLibrary` 資料庫 (分為 `last` 姓氏庫 與 `first` 名字庫)。
*   **生成流程**：
    1.  隨機抽取一個 **姓氏 (Last Name)**。
        *   **80%**：單字 (如：林)      **(v2.2 更新)**
        *   **15%**：雙字 (如：歐陽)    **(v2.2 更新)**
        *   **5%**：長字 (3字以上)      **(v2.2 更新)**
    2.  隨機抽取一個 **名字 (First Name)**。
    3.  組合為 `FullName`。
*   **補字邏輯 (Add Character Logic)**：
    *   **觸發條件**：
        1.  `FullName` 總長度 $\le 2$ (如：林豪)。
        2.  `Last` 長度 $> 1$ 且 `First` 長度 $= 1$ (如：歐陽鋒)。
    *   **機率**：符合上述任一條件時，**50% 機率** 觸發補字。
    *   **執行補字**：
        *   從 `first` 庫中再抽取一個字。
        *   **防呆檢查**：若抽到的字長度 $> 1$ (如抽到「志豪」)，則**強制取消補字**，維持原名 (避免出現「歐陽鋒志豪」)。
        *   若抽到的字長度 $= 1$，則追加至名字後方。
    *   **例外處理 1.**：外國譯名通常長度已 $> 2$ 且不符合複姓單名規則，故不觸發補字。
    *   **例外處理 2.**：補字時從名字庫再抽一字，若抽到多字詞則取消補字。

---

### 2.2 等級與天賦生成 (Grade & Untrainable Stats)

#### 2.2.1 決定等級
*   **機率分佈**：
    *   **G**: 28% | **C**: 26% | **B**: 22% | **A**: 14%
    *   **S**: 7% | **SS**: 2.5% | **SSR**: 0.5%

#### 2.2.2 生成不可訓練能力 (Untrainable Stats)
*   **定義**：代表球員的天賦，生成後無法透過訓練提升。
*   **項目 (10項)**：`體力`, `力量`, `速度`, `彈跳`, `手感`, `出手速度`, `進攻智商`, `防守智商`, `健康`, `運氣`。
*   **生成規則**：依據等級設定的「總和範圍」與「單項範圍」進行隨機生成。

**(V2.6 新增)**

| 中文名稱 | Config Key (YAML) | DB Field (Storage) | 備註說明 |
| :--- | :--- | :--- | :--- |
| **體力** | `ath_stamina` | `physical.stamina` | 影響體力以及比賽中能力變化 |
| **力量** | `ath_strength` | `physical.strength` | 基本運動能力，影響比賽表現 |
| **速度** | `ath_speed` | `physical.speed` | 基本運動能力，影響比賽表現 |
| **彈跳** | `ath_jump` | `physical.jumping` | 基本運動能力，影響比賽表現 |
| **健康** | `talent_health` | `physical.health` | 影響受傷機率與體力恢復加成 (隱藏數值) |
| **手感** | `shot_touch` | `offense.touch` | 影響投籃命中判定 |
| **出手速度** | `shot_release` | `offense.release` | 影響投籃命中判定 |
| **進攻智商** | `talent_offiq` | `mental.off_iq` | 影響投籃命中判定與進攻事件 |
| **防守智商** | `talent_defiq` | `mental.def_iq` | 影響投籃命中判定與防守事件 |
| **運氣** | `talent_luck` | `mental.luck` | 影響所有機率事件的微幅修正 (隱藏數值) |

| 等級 | 總和下限 (Sum Min) | 總和上限 (Sum Max) | 單項下限 (Stat Min) | 單項上限 (Stat Max) |
| :--- | :--- | :--- | :--- | :--- |
| **G** | 10 | 400 | 1 | 99 |
| **C** | 399 | 600 | 1 | 99 |
| **B** | 599 | 700 | 1 | 99 |
| **A** | 699 | 800 | 10 | 99 |
| **S** | 799 | 900 | 20 | 99 |
| **SS** | 900 | 950 | 30 | 99 |
| **SSR**| 951 | 990 | 91 | 99 |

---

### 2.3 身高與位置 (Height & Position)
*   **2.3.1 身高生成**：
    *   演算法：Box-Muller Transform (常態分佈)。
    *   參數：平均值 (Mean) **195cm**，標準差 (SD) **10**。
    *   範圍限制：**160cm ~ 230cm** (超出範圍需重骰)。
*   **2.3.2 位置判定**：由身高決定機率分佈 (非絕對切斷)。
    *   **< 190cm**：PG (60%), SG (40%)
    *   **190-199cm**：PG (35%), SG (45%), SF (20%)
    *   **200-209cm**：PF (50%), C (15%), SF (20%), SG (10%), PG (5%)
    *   **>= 210cm**：C (45%), PF (30%), SF (10%), SG (10%), PG (5%)

---

### 2.4 可訓練能力生成 (Trainable Stats Generation)
此步驟為生成流程中最複雜的環節，需綜合考量等級上限、位置檢核與身高修正。

*   **項目 (10項)**：`投籃技巧`, `射程`, `籃板`, `卡位`, `干擾`, `抄截`, `跑位`, `運球`, `傳球`, `控球`。

**(V2.6 新增)**

| 中文名稱 | Config Key (YAML) | DB Field (Storage) | 備註說明 |
| :--- | :--- | :--- | :--- |
| **投籃技巧** | `shot_accuracy` | `offense.accuracy` | 影響投籃命中判定 |
| **射程** | `shot_range` | `offense.range` | 影響投籃命中判定 |
| **傳球** | `off_pass` | `offense.passing` | 影響進攻事件 |
| **運球** | `off_dribble` | `offense.dribble` | 影響進攻事件 |
| **控球** | `off_handle` | `offense.handle` | 影響進攻事件 |
| **跑位** | `off_move` | `offense.move` | 影響進攻事件及防守事件 |
| **籃板** | `def_rebound` | `defense.rebound` | 影響籃板事件 |
| **卡位** | `def_boxout` | `defense.boxout` | 影響籃板事件 |
| **干擾** | `def_contest` | `defense.contest` | 影響防守事件 |
| **抄截** | `def_disrupt` | `defense.disrupt` | 影響防守事件 |

#### 2.4.1 基礎生成規則 (Base Logic)
1.  **隨機生成**：每項能力在 **1~99** 之間隨機生成。
2.  **反向總上限限制 (Reverse Cap)**：
    *   **設計意圖**：低等級球員 (G) 擁有較高的初始能力上限，代表「即戰力」；高等級球員 (SSR) 初始能力受限，代表需培養的「璞玉」。 (**v3.2 補充**)
    *   **G**: 800 | **C**: 700 | **B**: 650 | **A**: 600 | **S/SS/SSR**: 550
    *   *邏輯*：若總和 > 上限，則視為無效，觸發 **Reroll**。

#### 2.4.2 位置檢核機制 (Position Validation)
在基礎生成符合「反向總上限」後，需額外檢查數值分佈是否符合「位置特徵」。若不符合，視為無效，觸發 **Reroll**。

*   **C / PF (內線)**：
    *   條件：`(籃板 + 卡位 + 干擾) > (其他 7 項總和)`
*   **SG (得分後衛)**：
    *   條件：`(干擾 + 抄截 + 射程) > (其他 7 項總和)`
*   **PG (控球後衛)**：
    *   條件：`(抄截 + 運球 + 控球 + 傳球) > (其他 6 項總和)`
*   **SF (小前鋒)**：
    *   條件：無限制 (No Restriction)

#### 2.4.3 身高修正機制 (Height Modifiers)
依據身高區間，對生成結果進行「次數擇優/擇差」與「數值加成」。

| 身高區間 (cm) | 生成次數 (Trials) | 選擇邏輯 | 額外修正 (Bonus/Penalty) |
| :--- | :--- | :--- | :--- |
| **160 ~ 169** | **3 次** | 取**最高**總分者 | 全能力總和 **+30** (權重分配*) |
| **170 ~ 179** | **2 次** | 取**最高**總分者 | 全能力總和 **+20** (權重分配*) |
| **180 ~ 189** | **1 次** | N/A | 全能力 **+1** (總和 +10) |
| **190 ~ 209** | **1 次** | N/A | 無修正 |
| **210 ~ 219** | **2 次** | 取**最低**總分者 | 無修正 |
| **220 ~ 230** | **3 次** | 取**最低**總分者 | 無修正 |

*   **權重分配規則 (Weighted Distribution)**：
    *   針對 160-179cm 的額外加點 (+20/+30)，採隨機分配至 10 個項目。
    *   **限制**：分配時，PG 關鍵四項 (`抄截`, `運球`, `控球`, `傳球`) 獲得點數的機率/權重需 **大於** 其他 6 項。
*   **有效性判定**：上述「生成次數」中的每一次嘗試，都必須先通過 **2.4.1 (上限)** 與 **2.4.2 (位置)** 的檢核才算一次有效嘗試。

---

### 2.5 年齡生成 (Age Generation) **(v2.4 新增)**
*   **基礎規則**：SSR 級固定為 18 歲，每降一級，年齡浮動範圍 (Range) 增加 1 歲。
*   **公式**：`Age = 18 + Random(0, Grade_Offset)`
*   **各級對照**：
    *   **SSR**: 18 歲 (固定)
    *   **SS**: 18 ~ 19 歲
    *   **S**: 18 ~ 20 歲
    *   **A**: 18 ~ 21 歲
    *   **B**: 18 ~ 22 歲
    *   **C**: 18 ~ 23 歲
    *   **G**: 18 ~ 24 歲

---

## 3. 成長與老化系統 (Growth & Aging)

### 3.1 基礎參數
*   **賽季設定**：1 賽季 = **91 天** (70 場比賽)。
*   **初始年齡**：18 歲。
*   **體能極限**：單場上場時間上限約 **37 分鐘**。

### 3.2 成長期 (18 - 25 歲)
*   **機制**：累積上場時間換取訓練點數。
*   **公式**：每累積 48 分鐘 -> 獲得 1 點。
*   **幸運修正 (Luck Modifier)**：
    *   基準值：Luck 80。
    *   修正公式：實際獲得 = 基礎點數 * [1 + (Luck - 80) * 1%]。
    *   *效果：Luck 99 的球員成長速度快 19%。*

### 3.3 巔峰期 (26 - 29 歲)
*   **機制**：成長速度放緩。
*   **公式**：每累積 144 分鐘 -> 獲得 1 點。
*   **幸運修正**：同上。

### 3.4 退化期 (30 歲以上)
*   **機制**：非線性加速老化，包含「上場磨損」與「歲月流逝」。
*   **抗性系統 (Resilience)**：
    *   **幸運抗性**：[(Luck - 70) * 1%] (若 Luck < 70 則為 0)。
    *   **等級抗性**：A (1%), S (3%), SS (5%), SSR (10%)。
    *   **總抗性** = 幸運抗性 + 等級抗性。
*   **掉點公式 (負成長)**：
    1.  **上場磨損**：滿 [300 / MAX(1, Age-29)] 分鐘 -> 扣 1 點。
        *   *隨著年齡增加，分母變小，掉點門檻降低。*
    2.  **歲月流逝**：每 [10 - (Age-30)] 天 -> 扣 1 點。
        *   *隨著年齡增加，天數變少，掉點頻率變高。*
    3.  **抗性應用**：上述兩種扣點計算出的數值，扣點數 * (1 - 總抗性)。
*   **練球補償**：滿 [150 * (Age-29)] 分鐘 -> 補 1 點。

---

## 4. 經濟與其他 (Economy & Misc)

### 4.1.1 薪資計算 (Salary)
*   **公式**：所有能力總和 * 等級係數。**(v2.1 更新)**
*   **等級係數**：
    *   G: 1.0
    *   C: 1.1
    *   B: 1.3
    *   A: 1.6
    *   S: 2.0
    *   SS: 2.5
    *   SSR: 3.0

### 4.1.2 初始合約規則 (Initial Contract) **(v2.4 新增)**
球員生成時，依據等級自動賦予初始合約年限與角色定位。

|  等 級  | 合約年限  |  角色定位 (Role)    | 說明                                |
| :---    | :---     | :---               | :---                                |
| **SSR** | **4 季** | **明星 (Star)**     | 絕對核心，享有最高薪資加成與上場時間。 |
| **SS**  | **4 季** | **先發 (Starter)**  | 球隊主力。                           |
| **S**   | **4 季** | **先發 (Starter)**  | 球隊主力。                           |
| **A**   | **2 季** | **綠葉 (Rotation)** | 主要輪替球員。                       |
| **B**   | **2 季** | **綠葉 (Rotation)** | 主要輪替球員。                       |
| **C**   | **1 季** | **功能 (Role)**     | 功能性球員，特定戰術使用。            |
| **G**   | **1 季** | **板凳 (Bench)**    | 邊緣球員/陪練，填補名單使用。         |

### 4.2 點數分配
*   **分配方式**：**手動分配 (Manual)**。
*   **儲存**：球員獲得的訓練點數存入 `training_points` 欄位，由玩家決定加到哪一項可訓練能力上。

### 4.3 體重 (Weight)
*   **(v2.0 已移除)**
*   **(v1.0 公式 - 已移除)**：~~$(\text{Height} - 100) \times 0.9 + \text{Random}(-5, 5)$。~~

## 5. 開隊陣容檢核 (Team Creation Validation) **(v2.2 新增、v3.2 更新)**

### 5.1 執行邏輯
生成 15 人名單 -> 檢查「位置數量」與「等級數量」 -> 若任一條件不符合，則整隊重骰 (Reroll Team)。

### 5.2 位置檢核條件
1.  **C**  >= 2
2.  **PG** >= 2
3.  **PG + SG** >= 4
4.  **PF + SF** >= 4
5.  **高階位置覆蓋 (High-Tier Coverage) [New v3.3]**:
    *   範圍：**SSR (1人) + SS (2人) + S (2人)**，共 5 名球員。
    *   條件：上述 5 名球員的組合中，必須包含 **C, PF, SF, SG, PG** 五個位置各至少 1 名。
    *   *目的：確保玩家的高階核心陣容是完整的，避免開局神卡位置嚴重重疊。*

### 5.3 等級檢核條件 (強制分佈)
*   **SSR**: 1 人
*   **SS**: 2 人
*   **S**: 2 人
*   **A**: 2 人
*   **B**: 2 人
*   **C**: 2 人
*   **G**: 4 人

### 5.4 開隊球員特殊生成規則 (Initial Roster Stat Constraints) **(v3.3 新增)**
為了縮小開局隨機範圍，避免玩家初始隊伍中出現過多無法使用的球員，**僅在開隊生成階段**套用以下規則：

*   **啟用下限限制 (Enable Lower Bound)**：
    *   在執行 `2.4.1` 基礎生成時，額外增加下限檢查。
    *   **條件**：`可訓練能力總和` >= `上限 (Upper Cap) * 50%`。
    *   **參數**：`initial_team_min_ratio` = **0.5** (可於 YAML 配置)。

| 等級 | 開隊時下限 (Min) | 開隊時上限 (Max) | 說明 |
| :--- | :--- | :--- | :--- |
| **G** | **400** | 800 | 確保開隊 G 級球員至少有基礎戰力 |
| **C** | **350** | 700 | |
| **B** | **325** | 650 | |
| **A** | **300** | 600 | |
| **S/SS/SSR** | **275** | 550 | |

*   **注意**：此規則不適用於遊戲開始後的選秀或自由球員生成。
    
---

## 6. 上場時間分配系統 (Minutes Distribution System) **(v2.5 新增)**

### 6.1 系統概述
比賽模擬時，系統需將 **240 分鐘** (48分鐘 x 5人) 分配給登錄名單中的球員。分配機制採用 **「保底時間 + 權重浮動」** 演算法，確保核心球員地位，同時保留單場比賽的隨機性與調度彈性。

### 6.2 角色參數設定
不同合約角色擁有不同的「保底時間 (Base)」與「權重範圍 (Weight Range)」。

| 角色定位 (Role) | 保底時間 (Base) | 權重範圍 (Weight) | 說明 |
| :--- | :--- | :--- | :--- |
| **明星 (Star)** | **30 min** | **-1 ~ 5** | 絕對主力，波動極小，極低機率扣時。 |
| **先發 (Starter)** | **20 min** | **-2 ~ 7** | 主力球員，有較高機率獲得額外時間。 |
| **綠葉 (Rotation)**| **10 min** | **5 ~ 15** | 輪替核心，主要競爭剩餘時間的族群。 |
| **功能 (Role)** | **0 min** | **5 ~ 12** | 無保底，需靠權重爭取上場。 |
| **板凳 (Bench)** | **0 min** | **0 ~ 10** | 邊緣人，權重範圍大，可能 DNP 也可能爆發。 |

### 6.3 分配演算法 (Algorithm)

#### 步驟 1：計算總保底與剩餘時間
*   `Total_Base` = 所有球員保底時間總和。
*   `Remaining_Time` = 240 - `Total_Base`。

#### 步驟 2：生成單場權重
*   為每位球員隨機生成一個權重值 `W` (介於該角色的 Min ~ Max 之間)。
*   `Total_Weight` = 所有球員權重總和。

#### 步驟 3：計算單位時間價值 (Unit Value)
*   `Unit` = `Remaining_Time` / `Total_Weight`。

#### 步驟 4：計算個人時間
*   `Raw_Minutes` = `Base` + (`W` * `Unit`)。
*   **捨去規則**：取至小數點後第一位，第二位以後無條件捨去 (Floor)。
    *   公式：`Final_Minutes = floor(Raw_Minutes * 10) / 10`。

#### 步驟 5：尾數修正
*   由於捨去規則，分配後的總時間通常會略小於 240 分鐘。
*   **修正方式**：將剩餘的尾數 (通常 < 1 分鐘) 全部加給名單中的 **最後一位球員**。

### 6.4 範例模擬
假設剩餘時間 130 分鐘，總權重 65，則 `Unit = 2`。
*   **Star (W=-1)**: 30 + (-1 * 2) = **28 min**。
*   **Starter (W=7)**: 20 + (7 * 2) = **34 min** (手感火燙，上場時間超越明星)。
*   **Bench (W=0)**: 0 + (0 * 2) = **0 min** (DNP)。