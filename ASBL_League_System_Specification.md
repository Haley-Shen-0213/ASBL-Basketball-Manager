# ASBL 聯賽系統規格書 (League System Specification)

**版本**: 1.3
**最後更新**: 2026-02-16
**說明**: 本文件定義 ASBL 的賽季結構、核心與擴充聯賽機制、每日排程系統以及休賽季重置邏輯。
**狀態**: 草案 (Draft)

---

## 1. 系統概述 (System Overview)

ASBL 聯賽系統採用 **「核心與擴充雙層架構 (Core & Expansion Tiered Structure)」**。系統以 **36 支球隊** 的正式聯賽為核心基準，透過 **電腦球隊填充 (Bot Filling)** 與 **擴充配對 (Expansion Matching)** 機制，實現彈性的聯賽規模管理，確保所有玩家皆有完整的賽季體驗。

系統依據玩家數量 (`users.is_bot=0`) 採取以下三階段動態調節機制：

### 1.1 核心聯賽填充機制 (Core League Filling)
*   **觸發條件**: 非電腦玩家數量 **< 37**。
*   **運作邏輯**:
    *   **電腦補位**: 由電腦球隊 (Bot Teams) 自動補足至 36 隊，維持聯賽運作。
    *   **玩家接管 (Takeover)**: 當新玩家加入時，將直接接管現有的電腦球隊。
    *   **繼承項目**: 僅繼承「出賽場次」、「主客場分配數」及「勝負戰績」。
    *   **重置項目**: **不繼承**球員數據與陣容。新球隊將獲得全新的起始資金、聲望歸零，並重新生成球員名單。

### 1.2 新球隊過渡機制 (New Team Transition)
*   **觸發條件**: 非電腦玩家數量 **> 36** 且為 **賽季中途加入** 的新球隊。
*   **運作邏輯**:
    *   首個賽季不進入正式排名體系。
    *   **每日配對**: 每日隨機與其他非聯賽內的球隊進行對戰。
    *   **主客平衡**: 系統強制執行「一主一客」輪流進行的原則。

### 1.3 擴充聯賽配對機制 (Expanded League Matching)
*   **觸發條件**: 非電腦玩家數量 **> 36** 且為 **非中途加入** (即賽季初已存在) 的球隊。
*   **運作邏輯**:
    *   **賽制目標**: 確保每隊打滿 **70 場** (35 主場 / 35 客場)。
    *   **配對優先級**: 優先配對 **聲望 (Reputation)** 接近的球隊，以確保實力相當。
    *   **補賽機制**: 若配對落單或湊不齊對手，將安排與 **現有的電腦球隊 (Existing Bot Teams)** 進行補賽，而非生成臨時隊伍。

---

## 2. 賽季結構 (Season Structure)

單一賽季總長度為 **91 天**，分為三個階段。

| 階段 | 名稱 | 天數區間 | 說明 |
| :--- | :--- | :--- | :--- |
| **Phase 1** | **例行賽 (Regular Season)** | **Day 1 - 70** | 36 隊雙循環賽制，每隊打滿 70 場 (35主/35客)。 |
| **Phase 2** | **季後賽 (Playoffs)** | **Day 71 - 84** | 取前 16 強進行淘汰賽 (賽制: 3-3-3-5)。 |
| **Phase 3** | **休賽季 (Off-season)** | **Day 85 - 91** | **7 天**。進行選秀、自由球員簽約、球員訓練、賽季結算。 |

*   **體力設定**: 比賽結束後體力自動回滿 (Full Recovery)，無需跨日體力管理。

---

## 3. 聯賽分級與球隊狀態 (League Tiers & Team Status)

系統依據 `teams` 表中的 `status` 與 `is_official` 欄位區分球隊。

### 3.1 正式聯賽 (Official League)
*   **席位數量**: 固定 **36 席** (Team ID 1~36)。
*   **組成**: 真人玩家 + 電腦託管 (若真人不足 36)。
*   **賽程**: 採每日動態生成與公布 (詳見第 4 章)。
*   **排名**: 依據勝率與聲望積分排序，前 16 名晉級季後賽。

### 3.2 擴充聯賽 (Expansion League)
*   **席位數量**: 無上限 (Team ID 37+)。
*   **組成**: 超出 36 名之後的真人玩家。
*   **賽程**: 採每日動態生成與公布。
*   **目標**: 累積戰績與聲望，爭取下季進入正式聯賽的資格。

---

## 4. 每日排程系統 (Daily Schedule System)

系統以 **UTC+8 (台灣時間)** 為基準運作。

### 🕒 00:00 - 換日與配對 (Day Change & Matchmaking)
1.  **推進天數**: `Season.current_day += 1`。
2.  **執行配對**:
    *   **正式聯賽**: 依據雙循環邏輯生成今日對戰組合。
    *   **擴充聯賽**: 依據聲望接近原則配對，落單者配對現有電腦隊。
    *   **新球隊**: 執行隨機配對 (一主一客原則)。
3.  **公布賽程**: 將今日賽程狀態由 `PENDING` 改為 `PUBLISHED`，玩家可開始設定戰術。

### 🕒 19:00 - 比賽執行 (Match Execution)
1.  **鎖定名單**: 凍結所有球隊陣容 (Roster Lock)。
2.  **模擬比賽**: 執行比賽引擎 (Match Engine)，產出比分與數據。
3.  **結算獎勵**: 更新戰績 (W/L)、計算聲望變動。

---

## 5. 聲望與積分系統 (Reputation System)

除勝率外，**聲望 (Reputation)** 是衡量球隊實力的核心指標，也是擴充聯賽配對的主要依據。

### 5.1 基礎規則
*   **勝 (Win)**: +1 分
*   **敗 (Loss)**: -1 分

### 5.2 下剋上機制 (Upset Mechanics)
當對戰雙方排名差距 (Rank Diff) 超過 **5 名** 時觸發：

*   **下剋上 (Upset Win)**: 低排名擊敗高排名 -> **+3 分** (總計)。
*   **被爆冷 (Upset Loss)**: 高排名輸給低排名 -> **-2 分** (總計)。

---

## 6. 休賽季與賽季重置 (Off-season & Season Reset)

於 **休賽季 (Day 85 - 91)** 執行，不進行傳統升降級，而是進行球隊經營與新賽季準備。

### 6.1 球隊經營活動
在此期間，玩家需完成以下操作：
*   **合約管理**: 與球員重新簽訂合約或釋出。
*   **訓練發展**: 分配賽季累積的訓練點數。
*   **選秀與補強**: 參與新人選秀或自由市場簽約。

### 6.2 賽季重置 (Reset)
當 Day 91 結束進入新賽季 Day 1 時：
1.  **戰績歸零**: 所有球隊勝敗場數重置為 0。
2.  **聯賽重組**: 依據球隊總數與聲望重新計算分組 (決定哪些球隊進入核心 36 強)。
3.  **賽程生成**: 新賽季賽程維持 **「當天安排、當天公布」** 的機制，不預先生成整季賽程。

---

## 7. 資料庫關鍵設計 (Database Schema Changes)

### 7.1 Users 表
```sql
-- 識別帳號是否為電腦代理
is_bot TINYINT(1) DEFAULT 0 COMMENT '0: 真人, 1: 電腦'
```

### 7.2 Teams 表
```sql
-- 球隊狀態與分級
status VARCHAR(20) COMMENT 'BOT, PLAYER, PROVISIONAL'
is_official BOOLEAN COMMENT 'True: 正式聯賽, False: 擴充聯賽'
reputation INT COMMENT '聲望積分'
season_wins INT COMMENT '本季勝場'
season_losses INT COMMENT '本季敗場'
home_games_played INT DEFAULT 0 COMMENT '已進行主場數'
away_games_played INT DEFAULT 0 COMMENT '已進行客場數'
```