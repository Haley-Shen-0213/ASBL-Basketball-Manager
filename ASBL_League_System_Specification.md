# ASBL 聯賽系統規格書 (League System Specification)

**版本**: 1.3
**文件類型**: 系統規格 (System Specification)
**狀態**: **已定案 (Confirmed)**
**最後更新**: 2026-02-20

**變更記錄**:
*   **v1.0**: 初始版本，定義核心與擴充聯賽。
*   **v1.1**: 修正球隊狀態定義。
*   **v1.2**: 
    *   **架構重構**: 改為多層級聯賽 (Tier System)，每層級固定 36 隊。
    *   **賽季日程**: 詳細定義 Day 1 ~ Day 91 的每日活動，包含季後賽詳細排程。
    *   **聲望系統**: 分離例行賽與季後賽計分規則，季後賽移除倒扣機制。
    *   **重置機制**: 定義 Day 1 的全聯盟重組與賽程優化邏輯。
*   **v1.3**: 
    *   **過渡機制**: 改為無紀錄、無經濟影響的隨機熱身賽。
    *   **賽程機制**: 正式聯賽於 Day 1 產生整季賽程；過渡聯賽每日產生。
    *   **季後賽**: 確立 BO3/BO5 賽制，新增季軍戰與排名聲望獎勵。
    *   **資料庫**: 新增 `Leagues` 資料表管理分組。

---

## 1. 聯賽架構與球隊進場機制 (League Structure & Entry)

ASBL 採用 **「多層級金字塔架構 (Multi-Tier Pyramid)」**。每個聯賽層級 (Tier) 固定由 **36 支球隊** 組成。系統依據玩家總數動態增減層級數量 (T0, T1, T2...)。

### 1.1 聯賽層級定義
*   **T0 (頂級聯賽)**: 伺服器中聲望最高的 36 支球隊。
*   **T1, T2... (次級聯賽)**: 依聲望排名依序組成的聯賽。
*   **完整性原則**: 每個聯賽必須維持 **36 支** 球隊。若真人玩家不足，系統將自動生成 **電腦球隊 (Bot Teams)** 填補空缺。

### 1.2 玩家進場機制 (Player Entry Logic)
當新玩家註冊或球隊狀態變更時，系統依據以下邏輯處理：

#### 情境 A: 核心聯賽填充 (Core Filling)
*   **條件**: `玩家總數` <= `36 * 現有聯賽層數`。
*   **邏輯**: 新玩家將直接 **接管 (Takeover)** 最底層聯賽中現有的電腦球隊。
*   **繼承**: 繼承該電腦隊的賽程、戰績。
*   **重置**: 重置球員名單、資金與聲望 (視為新經營者接手)。

#### 情境 B: 擴充聯賽配對 (Expansion Matching) - 休賽季/換季日
*   **條件**: `玩家總數` > `36 * 現有聯賽層數` 且發生於 **Day 90-91 或 Day 1**。
*   **邏輯**: 系統開啟新的聯賽層級 (例如 T2)，將多出的玩家放入，並生成電腦球隊補足至 36 隊。

#### 情境 C: 新球隊過渡機制 (Provisional Transition) - 季中加入
*   **條件**: `玩家總數` > `36 * 現有聯賽層數` 且發生於 **賽季進行中 (Day 2 ~ Day 89)**。
*   **狀態**: 球隊標記為 `PROVISIONAL` (過渡期)。
*   **運作 (熱身賽模式)**:
    *   **隨機配對**: 每日隨機與其他 `PROVISIONAL` 球隊或閒置電腦隊進行對戰。
    *   **無紀錄**: 比賽數據 **不列入** 生涯紀錄、不計算勝敗戰績。
    *   **無成長**: 球員 **不獲得** 訓練點數或經驗值。
    *   **無經濟**: **不產生** 門票收入，亦 **不扣除** 球員薪資。
    *   **轉正時機**: 於下個賽季 **Day 1** 重新分組時正式進入聯賽體系。

---

## 2. 賽季升降與重組機制 (Season Reset & Relegation)

ASBL 不採用傳統的「升3降3」制，而是採用 **「全聯盟聲望重排 (Global Reputation Re-seeding)」** 機制，確保每個賽季的分組皆符合當前實力。

### 2.1 執行時機
於每個賽季的 **Day 1 (換季日)** 00:00 執行。

### 2.2 重組邏輯
1.  **全域排序**: 撈取伺服器內所有 `status='PLAYER'` 的球隊，依據 **聲望 (Reputation)** 由高至低排序。
2.  **斷點分配**:
    *   **第 1 ~ 36 名** -> 分配至 **T0 聯賽**。
    *   **第 37 ~ 72 名** -> 分配至 **T1 聯賽**。
    *   以此類推...
3.  **同分判定 (Tie-Breaker)**:
    *   若在分組斷點 (例如第 36 名與第 37 名) 出現多名玩家聲望相同。
    *   **處理**: 系統將從這些同分玩家中 **隨機抽選** 足夠的人數補滿上級聯賽，其餘分配至下一級聯賽。
4.  **電腦補位**: 分配完所有玩家後，若最後一個聯賽不足 36 隊，生成電腦球隊補滿。
5.  **分組寫入**:
    *   建立新賽季的 `Leagues` 資料 (T0, T1...)。
    *   依排序將球隊寫入 `League_Participants` 資料表。
    *   若人數不足 36 的倍數，生成電腦球隊補滿最後一個聯賽。

---

## 3. 賽季日程表 (Season Schedule)

單一賽季長度為 **91 天**。

| 天數 (Day) | 階段 | 事件與活動 | 備註 |
| :--- | :--- | :--- | :--- |
| **Day 1** | **換季日** | 1. **聯賽重組**: 執行聲望重排與分組。<br>2. **賽程計算**: 依據《賽程排定與優化規格書 v1.0》生成新賽季賽程並公布。<br>3. **名單清理**: 清空並封存所有過期未簽約的球探名單。<br>4. **休市**: 當日無比賽，賽程頁面顯示新賽季預告。 | 系統維護核心日 |
| **Day 2 - 71** | **例行賽** | 進行 70 場循環賽 (35主/35客)。 | 每日 19:00 開打 |
| **Day 72** | **休息日** | 例行賽結算，公布 **季後賽第一輪 (16強)** 對戰組合。 | 非季後賽球隊賽季結束 |
| **Day 73 - 75** | **季後賽 R1** | 16強淘汰賽 (**BO3**, 3戰2勝制)。 | |
| **Day 76** | **休息日** | 公布 **季後賽第二輪 (8強)** 對戰組合。 | |
| **Day 77 - 79** | **季後賽 R2** | 8強淘汰賽 (**BO3**, 3戰2勝制)。 | |
| **Day 80** | **休息日** | 公布 **季後賽第三輪 (4強)** 對戰組合。 | |
| **Day 81 - 83** | **季後賽 R3** | 準決賽 (**BO3**, 3戰2勝制)。 | |
| **Day 84** | **休息日** | 公布 **總冠軍賽** 與 **季軍戰** 對戰組合。 | |
| **Day 85 - 89** | **總冠軍賽** | **總冠軍賽、季軍戰**: **BO5** (5戰3勝制)。 | 決定最終排名 (1~4名) |
| **Day 90 - 91** | **休賽季** | 發放賽季獎勵、合約更新、球員訓練結算。 | 準備進入下一季 |

*   **特殊規則**:
    *   **無季後賽球隊**: Day 72 後無正式賽程。但若新玩家在此期間加入並接管了「已晉級季後賽的電腦隊」，則可直接參與季後賽。
    *   **體力**: 每日比賽結束後自動回滿 (Full Recovery)。
    *   **BO3 (Best of 3)**: 先取得 2 勝者晉級，若 2-0 則第三天不比賽。
    *   **BO5 (Best of 5)**: 先取得 3 勝者奪冠，若 3-0 或 3-1 則後續天數不比賽。

---

## 4. 每日排程系統 (Daily Schedule System)

系統以 **UTC+8 (台灣時間)** 為基準運作。

### 🕒 00:00 - 換日與行政作業
1.  **推進天數**: `Season.current_day += 1`。
2.  **賽程管理**:
    *   **正式聯賽**: (無需動作) 賽程已於 Day 1 全數產生並設定為 `PUBLISHED`，玩家可隨時查看整季完整賽程。
    *   **過渡聯賽 (Provisional)**: 針對目前線上的過渡球隊，**即時隨機產生** 當日對戰組合並公布。
3.  **季後賽清理 (Series Cleanup)**:
    *   檢查前一日的比賽結果。
    *   若某系列賽已分出勝負 (如 BO3 達成 2-0 或 BO5 達成 3-0/3-1)，系統將 **自動移除/取消** 該對戰組合後續未執行的賽程 (例如 Day 75 的第三戰)，避免產生無效比賽。

### 🕒 19:00 - 比賽執行 (Match Execution)
1.  **鎖定名單**: 凍結所有球隊陣容。
2.  **模擬比賽**: 執行比賽引擎。
    *   *注意*: 過渡聯賽 (Provisional) 的比賽結果不寫入歷史統計。
3.  **結算獎勵**: 更新戰績、計算聲望。

---

## 5. 聲望與積分系統 (Reputation System)

### 5.1 例行賽聲望規則 (Regular Season)
適用於 Day 2 ~ Day 71。

*   **勝 (Win)**: **+1** 分
*   **敗 (Loss)**: **-1** 分
*   **下剋上機制**:
    *   觸發條件: 排名差距 > 5 名。
    *   **下剋上 (Upset Win)**: 額外 **+2** 分 (總計 +3)。
    *   **被爆冷 (Upset Loss)**: 額外 **-1** 分 (總計 -2)。

### 5.2 季後賽聲望規則 (Playoffs)
適用於 Day 73 ~ Day 89。**季後賽無倒扣機制**。

#### A. 單場獎勵
*   **出賽獎勵**: 每場 **+1** 分 (無論勝敗)。
*   **勝場獎勵**: 贏得比賽 **+1** 分 (總計 +2)。
*   **強者挑戰**: 低種子擊敗高種子 **+1** 分 (總計 +3)。

#### B. 系列賽獎勵
*   **提前晉級 (Early Finish)**: 若在 BO3 以 2-0 或 BO5 以 3-0/3-1 結束系列賽，勝方額外獲得 **+5** 分 (獎勵其統治力)。

#### C. 最終排名獎勵 (Season End)
於季後賽結束後一次性發放：
*   **總冠軍 (Champion)**: **+20** 分
*   **亞軍 (Runner-up)**: **+10** 分
*   **季軍 (3rd Place)**: **+5** 分

---

## 6. 資料庫關鍵設計 (Schema Update)

### 6.1 Leagues 表 (新增)
紀錄每個賽季的聯賽分組資訊。

```sql
CREATE TABLE leagues (
    id INT PRIMARY KEY AUTO_INCREMENT,
    season_id INT NOT NULL,
    tier INT NOT NULL COMMENT '0: T0, 1: T1, 2: T2...',
    name VARCHAR(64) COMMENT '聯賽名稱 e.g. Alpha League',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (season_id) REFERENCES seasons(id)
);
```

### 6.2 League_Participants 表 (新增)
紀錄該賽季、該聯賽有哪些球隊。

```sql
CREATE TABLE league_participants (
    id INT PRIMARY KEY AUTO_INCREMENT,
    league_id INT NOT NULL,
    team_id INT NOT NULL,
    start_reputation INT COMMENT '季初分組時的聲望快照',
    final_rank INT COMMENT '季末結算排名',
    FOREIGN KEY (league_id) REFERENCES leagues(id),
    FOREIGN KEY (team_id) REFERENCES teams(id)
);
```

### 6.3 Teams 表 (修正)
移除 `league_tier`，改由關聯表查詢。

```sql
-- 移除 league_tier 欄位
-- 保留以下欄位
reputation INT DEFAULT 0
season_wins INT DEFAULT 0
season_losses INT DEFAULT 0
status VARCHAR(20) COMMENT 'PLAYER, BOT, PROVISIONAL'
```