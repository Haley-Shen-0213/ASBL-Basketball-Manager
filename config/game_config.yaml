# config/game_config.yaml
# =============================================================================
# ASBL 遊戲核心設定檔 (Final Version - Commented)
# 對應規格書: 
#   - Player System Specification v3.4 (2026/01/25 Update)
#   - Match Engine Specification v2.4 (2026/01/23 Update)
# 路徑 config/game_config.yaml
# =============================================================================

# [Spec v3.3] 姓名生成策略設定
# 將語系分類移至設定檔，方便擴充
name_generation:
  strategies:
    # 策略 A: 歐美語系 (Western) - 隨機抽3個字組合，用間隔號分隔
    western: ['en', 'es', 'pt', 'ru', 'de', 'fr', 'it']
    
    # 策略 B: 東亞語系 (East Asian) - 姓+名(1-2字)，無分隔符
    east_asian: ['zh', 'ja', 'ko']
    
    # 策略 C: 原住民語系 (Indigenous) - 隨機抽2個不重複字組合，用間隔號分隔
    indigenous: ['tw_aboriginal']

system: # 系統設定
  season_days: 91 # 賽季天數
  games_per_season: 70 # 賽季比賽數
  
  # 活躍玩家判定天數 (例如: 7天內有登入視為活躍)
  active_user_threshold_days: 7
  
  # 初始球隊設定
  initial_team_settings:
    funds: 300000           # 初始資金 30萬
    reputation: 0           # 初始聲望 0
    scout_chances: 100      # 初始球探次數 100
    roster_limit: 40        # 球員人數上限

  # 季後賽設定 (Playoff Configuration)
  playoff:
    series_length:
      round_1: 3  # 16強賽 (打滿3場)
      round_2: 3  # 8強賽 (打滿3場)
      round_3: 3  # 4強賽 (打滿3場)
      finals: 5   # 總冠軍賽 (打滿5場)
    
    # 用於程式邏輯判斷是否要強制打滿 (True=打滿, False=搶勝制)
    force_full_series: False 

# =============================================================================
# [New] 聯賽系統設定 (League System) - Spec v1.3 & Schedule Spec v1.0
# =============================================================================
league_system:
  structure:
    teams_per_tier: 36 # 每個聯賽層級的球隊數
  
  # 賽程優化參數 (Schedule Optimization)
  schedule:
    optimization:
      iterations: 30000000 # 蒙地卡羅模擬次數 (正式環境建議 30,000,000)
      elite_pool_size: 1000 # 保留前 N 個最佳解
      penalty_weights:
        streak_2: 1
        streak_3: 3
        streak_4: 5
        streak_5: 10
        streak_6_plus: 30
  
  # 聲望系統參數 (Reputation)
  reputation:
    regular:
      win: 1
      loss: -1
      upset_threshold: 5    # 排名差距 > 5 視為下剋上
      upset_win_bonus: 2    # 下剋上額外加分 (總計 1+2=3)
      upset_loss_penalty: -1 # 被爆冷額外扣分 (總計 -1-1=-2)
    
    playoff:
      participation: 1      # 出賽獎勵
      win: 1                # 勝場獎勵 (總計 1+1=2)
      upset_bonus: 1        # 強者挑戰獎勵
      series_win_early_bonus: 5 # 提前晉級獎勵
      
      # 賽季結算排名獎勵
      season_end:
        champion: 20
        runner_up: 10
        third_place: 5

# =============================================================================
# 1. 球員生成設定 (Player Generation)
# 對應規格書: Player System v3.2
# =============================================================================
generation:
  # [Spec v3.1 Section 2.2.1] 等級與機率
  grades: ["SSR", "SS", "S", "A", "B", "C", "G"]
  grade_weights: [0.005, 0.025, 0.07, 0.14, 0.22, 0.26, 0.28]
  
  # [Spec v3.1 Section 4.1.1] 薪資係數
  # 計算公式: 球員薪資 = (20項屬性總和) * 該等級係數
  # 用途: 決定球員身價，等級越高，每一點能力值換算的薪水越高
  salary_factors:
    SSR: 3.0
    SS: 2.5
    S: 2.0
    A: 1.6
    B: 1.3
    C: 1.1
    G: 1.0

  # [Spec v3.1 Section 2.5] 年齡生成規則
  # 用途: 決定新秀的初始年齡，SSR 最年輕(潛力最大)，G 級平均年齡較大
  age_rules:
    base: 18
    offsets: {SSR: 0, SS: 1, S: 2, A: 3, B: 4, C: 5, G: 6}

  # [Spec v3.1 Section 4.1.2] 初始合約規則
  # 用途: 生成球員時自動賦予的合約長度與角色定位
  contracts:
    SSR: {years: 4, role: "Star"}
    SS:  {years: 4, role: "Star"}
    S:   {years: 4, role: "Starter"}
    A:   {years: 2, role: "Rotation"}
    B:   {years: 2, role: "Rotation"}
    C:   {years: 1, role: "Role"}
    G:   {years: 1, role: "Bench"}

  # [Spec v3.1 Section 2.2.2 & 2.4] 屬性定義
  attributes:
    untrainable: ["ath_stamina", "ath_strength", "ath_speed", "ath_jump", "shot_touch", "shot_release", "talent_offiq", "talent_defiq", "talent_health", "talent_luck"]
    trainable: ["shot_accuracy", "shot_range", "def_rebound", "def_boxout", "def_contest", "def_disrupt", "off_move", "off_dribble", "off_pass", "off_handle"]

  # [Spec v3.1 Section 2.2.2] 天賦生成規則 (Untrainable)
  untrainable_rules:
    G:   {sum_min: 10,  sum_max: 400, stat_min: 1, stat_max: 99}
    C:   {sum_min: 399, sum_max: 600, stat_min: 1, stat_max: 99}
    B:   {sum_min: 599, sum_max: 700, stat_min: 1, stat_max: 99}
    A:   {sum_min: 699, sum_max: 800, stat_min: 10, stat_max: 99}
    S:   {sum_min: 799, sum_max: 900, stat_min: 20, stat_max: 99}
    SS:  {sum_min: 900, sum_max: 950, stat_min: 30, stat_max: 99}
    SSR: {sum_min: 951, sum_max: 990, stat_min: 91, stat_max: 99}

  # [Spec v3.1 Section 2.4.1] 技術反向總上限 (Trainable Caps)
  # 用途: 限制可訓練屬性的初始總和，等級越低上限越高(即戰力)，等級越高上限越低(需培養)
  trainable_caps:
    G: 800
    C: 700
    B: 650
    A: 600
    S: 550
    SS: 550
    SSR: 550

  # [Spec v3.1 Section 2.3.1] 身高生成參數 (New)
  # 用途: 定義 Box-Muller 演算法的參數，避免寫死在程式碼中
  height_distribution:
    mean: 195
    std_dev: 10
    min: 160
    max: 230

  # [Spec v3.1 Section 2.3.2] 位置判定矩陣 (New)
  # 用途: 定義不同身高區間的位置機率分佈
  # 邏輯: 程式會依序檢查 max_height，符合則使用該組權重
  position_matrix:
    - max_height: 189
      weights: {PG: 60, SG: 40}
    - max_height: 199
      weights: {PG: 35, SG: 45, SF: 20}
    - max_height: 209
      weights: {PF: 50, SF: 20, C: 15, SG: 10, PG: 5}
    - max_height: 999 # 210+ (Catch-all)
      weights: {C: 45, PF: 30, SF: 10, SG: 10, PG: 5}

  # [Spec v3.1 Section 2.4.2] 位置檢核機制 (Position Validation) [v3.1 new]
  # 用途: 確保生成的能力值分佈符合該位置的特徵，否則重骰
  position_validation:
    C:
      condition: "sum(def_rebound, def_boxout, def_contest) > sum(others)"
      others_count: 7
    PF:
      condition: "sum(def_rebound, def_boxout, def_contest) > sum(others)"
      others_count: 7
    SG:
      condition: "sum(def_contest, def_disrupt, shot_range) > sum(others)"
      others_count: 7
    PG:
      condition: "sum(def_disrupt, off_dribble, off_handle, off_pass) > sum(others)"
      others_count: 6
    SF:
      condition: "none" # 無限制

  # [Spec v3.1 Section 2.4.3] 身高修正機制 (Height Modifiers) [v3.1 new]
  # 用途: 根據身高區間調整生成次數與數值加成
  height_modifiers:
    "160-169":
      trials: 3
      selection: "max" # 取最高總分
      bonus_points: 30
      bonus_type: "weighted" # 權重分配 (PG 關鍵屬性權重較高)
      key_ratio_min: 0.5
      key_ratio_max: 1.0
    "170-179":
      trials: 2
      selection: "max"
      bonus_points: 20
      bonus_type: "weighted" # 權重分配 (PG 關鍵屬性權重較高)
      key_ratio_min: 0.5
      key_ratio_max: 1.0
    "180-189":
      trials: 1
      selection: "none"
      bonus_points: 10 # 全能力+1 = 總和+10
      bonus_type: "flat" # 平均分配 (+1 per stat)
    "190-209":
      trials: 1
      selection: "none"
      bonus_points: 0
      bonus_type: "none"
    "210-219":
      trials: 2
      selection: "min" # 取最低總分
      bonus_points: 0
      bonus_type: "none"
    "220-230":
      trials: 3
      selection: "min"
      bonus_points: 0
      bonus_type: "none"

  # [Spec v3.1 Section 2.4.3] 權重分配規則 (Weighted Distribution Keys) [v3.1 new]
  # 用途: 定義身高補償點數分配時，哪些屬性權重較高 (針對 PG 關鍵四項)
  weighted_bonus_keys:
    high_priority: ["def_disrupt", "off_dribble", "off_handle", "off_pass"]
    low_priority: ["shot_accuracy", "shot_range", "def_rebound", "def_boxout", "def_contest", "off_move"]

# =============================================================================
# 2. 團隊與時間設定 (Team & Minutes)
# 對應規格書: Player System v3.1 Section 5 & 6
# =============================================================================
team_creation:
  # [Spec v3.1 Section 5] 開隊陣容檢核標準
  composition_count: {SSR: 1, SS: 1, S: 1, A: 2, B: 3, C: 2, G: 5} # 總共 15 人
  validation:
    min_c: 2       # 最少中鋒數
    min_pg: 2      # 最少控衛數
    min_guards: 4  # PG+SG 總數下限
    min_forwards: 4 # SF+PF 總數下限
    
    # [Spec v3.5 Section 5.2] 分層位置覆蓋規則 (Updated)
    # 程式邏輯: 遍歷列表中的每一條規則，檢查符合 target_grades 的球員集合是否包含 required_positions
    coverage_rules:
      - name: "High Tier (SSR-A)"
        target_grades: ["SSR", "SS", "S", "A"]
        required_positions: ["C", "PF", "SF", "SG", "PG"]
      
      - name: "Mid Tier (B-C)"
        target_grades: ["B", "C"]
        required_positions: ["C", "PF", "SF", "SG", "PG"]

  # [Spec v3.2 Section 5.4] 開隊球員特殊生成規則 (New)
  # 用途: 僅在開隊時啟用能力下限限制，縮小隨機範圍
  initial_team_min_ratio: 0.5 # 下限 = 上限 * 50%

minutes_distribution:
  # [Spec v3.1 Section 6] 上場時間分配
  total_minutes: 240
  roles:
    Star:     {base: 30, min_w: -1, max_w: 5}
    Starter:  {base: 20, min_w: -2, max_w: 7}
    Rotation: {base: 10, min_w: 5,  max_w: 15}
    Role:     {base: 0,  min_w: 5,  max_w: 12}
    Bench:    {base: 0,  min_w: 0,  max_w: 10}

# =============================================================================
# 3. 比賽引擎設定 (Match Engine)
# 對應規格書: Match Engine Specification v1.4
# =============================================================================
match_engine:
  # === 全域設定 (General Rules) ===
  general:
    quarter_length: 720            # 每節比賽秒數 (12分鐘)
    ot_length: 300                 # 延長賽秒數 (5分鐘)
    
    # [Spec v1.5 New] 犯規與換人規則
    substitution:
      foul_limit: 6                # 犯滿離場次數
      stamina_threshold: 80.0      # 低於此體力觸發換人
      clutch_time_threshold: 120   # [Spec v2.1] 關鍵時刻定義 (最後2分鐘)
      
      # 犯滿離場後的時間重分配邏輯
      redistribution:
        method: "positional_top_k" # 邏輯名稱: 每個位置取前 K 名
        top_k: 3                   # 取前 3 名
        positions: ["C", "PF", "SF", "SG", "PG"] # 遍歷順序 (共 15 個 slot)
    
    # [Spec v2.1] 體力系統參數 (更新)
    stamina_recovery_halftime: 20.0 # 中場休息時間 (分鐘)
    stamina_recovery_quarter: 2.0   # 節間休息時間 (分鐘)
    stamina_nerf_threshold: 80     # 體力低於此數值開始，能力值會線性衰退
    stamina_min_multiplier: 0.21   # 體力耗盡(剩1)時，能力值剩下的百分比 (21%)
    stamina_drain_coeff: 3.0       # 體力消耗公式的倍率係數 (數值越大消耗越快)

  # [Spec v2.1 Section 1.5] 賽前身高修正 (New)
  height_correction:
    bonus_threshold: 190 # BONUS_H
    nerf_threshold: 210  # NERF_H
    affected_attrs:
      speed_dribble:
        keys: ['ath_speed', 'off_dribble']
        coeff: 0.02
      handle_disrupt:
        keys: ['off_handle', 'def_disrupt']
        coeff: 0.01

  # [Spec v1.4 Section 2.3 & 2.4] 體力計算公式成分
  stamina_system:
    drain_attrs: ['ath_stamina', 'talent_health']   # 消耗公式: 3.0 * [1+(1-體能)] + (1-健康)
    recover_attrs: ['ath_stamina', 'talent_health'] # 恢復公式: 1.0 + 體能 - (1-健康)
    age_threshold: 20      # [New Spec v2.1]
    age_decay_rate: 0.01   # [New Spec v2.1]

  # [Spec 1.6 Section 1.5] 開場跳球設定 (New)
  jump_ball:
    # 參與者篩選公式: 身高 + 彈跳 + 進攻智商
    participant_formula: ['height', 'ath_jump', 'talent_offiq']
    # 獲勝機率計算: 依據數值總和比例 (無額外隨機係數，純看數值佔比)
    random_factor: 0.0 

  # [Spec v1.4 Section 1.1] 位置能力評分 (Positional Scoring)
  # 用途: 決定 Best 5 與 輪替順序，定義每個位置看重哪些屬性
  positional_scoring:
    C:  ['height', 'ath_strength', 'def_rebound', 'def_boxout', 'def_contest']
    PF: ['height', 'ath_strength', 'def_rebound', 'def_boxout', 'def_contest', 'ath_jump', 'ath_speed']
    SF: ['all_stats', 'height'] 
    SG: ['shot_touch', 'shot_release', 'talent_offiq', 'talent_defiq', 'def_contest', 'def_disrupt', 'shot_range']
    PG: ['ath_speed', 'talent_offiq', 'def_disrupt', 'off_dribble', 'off_pass', 'off_handle', '-height'] # 負號代表扣分

  # [Spec v1.4 Section 5.1.A] 屬性池定義
  # 用途: 定義「進攻總值」與「防守總值」包含哪些屬性
  attr_pools:
    off_14: ['ath_strength', 'ath_speed', 'ath_jump', 'shot_touch', 'shot_release', 'talent_offiq', 'talent_luck', 'shot_accuracy', 'shot_range', 'off_move', 'off_dribble', 'off_pass', 'off_handle', 'height']
    def_12: ['ath_strength', 'ath_speed', 'ath_jump', 'shot_touch', 'shot_release', 'talent_defiq', 'talent_luck', 'def_rebound', 'def_boxout', 'def_contest', 'def_disrupt', 'off_move'] # Def 移除 height (由公式獨立處理或屬性池不含), Spec 5.2.A Def_Total 包含 height, 這裡補上
    def_12_with_height: ['ath_strength', 'ath_speed', 'ath_jump', 'shot_touch', 'shot_release', 'talent_defiq', 'talent_luck', 'height', 'def_boxout', 'def_contest', 'def_disrupt', 'off_move']
    all_stats: [
      'ath_stamina', 'ath_strength', 'ath_speed', 'ath_jump', 
      'shot_touch', 'shot_release', 'talent_offiq', 'talent_defiq', 'talent_health', 'talent_luck',
      'shot_accuracy', 'shot_range', 'def_rebound', 'def_boxout', 'def_contest', 'def_disrupt', 
      'off_move', 'off_dribble', 'off_pass', 'off_handle', 'height'
    ]

  # === 後場階段 (Backcourt Phase) [Spec v1.4 Section 3] ===
  backcourt:
    params:
      time_base_min: 3.5         # 基礎過半場時間下限 (秒)
      time_base_max: 4.5         # 基礎過半場時間上限 (秒)
      time_coeff: 0.008          # 時間修正係數: (防守總值 - 進攻總值) * 0.008
      violation_threshold: 8.0   # 超過此秒數 -> 8秒違例 (失誤)
      steal_threshold: 3.0       # 超過此秒數 -> 觸發後場抄截判定
      fastbreak_threshold: 1.5   # 低於此秒數 -> 觸發快攻判定
      fastbreak_trigger_prob: 0.4 # [New] 滿足時間門檻後，實際觸發快攻的機率 (50%)
      steal_base_prob: 0.01      # 後場抄截基礎機率 (1%)
      steal_bonus_coeff: 0.001   # 抄截機率加成: (防守差值) * 0.1%
      
      # [v2.3] 抄截轉換設定
      transition_base_prob: 0.50   # 基礎機率 50%
      
      # [New v2.4] 速度折扣參數
      speed_discount_coeff: 0.1  # 折扣係數 (Random(0, AvgSpeed * coeff))
      speed_discount_coeff_def: 0.5  # 防守方折扣係數 
      min_time_limit: 0.5        # 後場時間物理下限

    formulas:
      # [Spec 3.1] 屬性池 (增加身高懲罰)
      off_sum: ['off_dribble', 'off_pass', 'talent_offiq', '-height']       # 決定過半場速度的進攻屬性
      def_sum: ['def_disrupt', 'def_contest', 'talent_defiq', '-height']    # 決定過半場阻礙的防守屬性
      # [Spec 3.4] 抄截判定 (Def - Off)
      steal_off: ['off_dribble', 'off_pass', 'talent_offiq', '-height']     # 被抄截者的抵抗屬性
      steal_def: ['def_disrupt', 'def_contest', 'talent_defiq', '-height']  # 抄截者的攻擊屬性
      # [v2.3] 轉換判定用的速度總和 (全隊)
      team_speed_sum: ['ath_speed']
      
      # [New v2.4] 後場速度折扣計算用 (3人)
      backcourt_speed: ['ath_speed']

    # [Spec v1.4 Section 3.5] 快攻判定
    fastbreak:
      params:
        base_success_min: 0.3    # 快攻基礎成功率下限 (30%)
        base_success_max: 1.0    # 快攻基礎成功率上限 (100%)
        stat_diff_coeff: 0.005   # 成功率修正: (屬性差) * 0.5%
        foul_base_prob: 0.01     # 快攻犯規基礎機率 (1%)
        foul_iq_coeff: 0.01      # 犯規智商修正: (IQ差) * 1%

      formulas:
        runner_selection: ['ath_speed', 'off_dribble']   # 決定誰跑快攻 (跑最快者)
        chaser_selection: ['ath_speed', 'talent_defiq']  # 決定誰追防 (追最快者)
        
        # [Spec 3.5.A] 快攻綜合能力 (9項 vs 9項)
        off_power: ['ath_strength', 'ath_speed', 'ath_jump', 'shot_touch', 'shot_release', 'talent_offiq', 'talent_luck', 'off_move', 'off_dribble', 'shot_accuracy']
        def_power: ['ath_strength', 'ath_speed', 'ath_jump', 'shot_touch', 'shot_release', 'talent_defiq', 'talent_luck', 'def_contest', 'def_disrupt']
        
        # [Spec 3.5.C] 犯規判定
        foul_off_iq: ['talent_offiq'] # 進攻方 IQ
        foul_def_iq: ['talent_defiq'] # 防守方 IQ

  # === 前場階段 (Frontcourt Phase) [Spec v1.4 Section 4] ===
  frontcourt:
    params:
      time_min_limit: 4.0        # 前場進攻時間下限 (最快4秒出手)
      time_quality_base: 7.0     # 品質基準秒數 (低於7秒開始有命中加成)
      spacing_bonus_coeff: 0.1   # 空間加成權重 (10%)
      
      # [New v2.4] 速度折扣與違例參數
      speed_discount_coeff: 0.01  # 折扣係數
      violation_threshold: 24.0  # 24秒違例總時間閾值
      absolute_min_time: 0.4     # 前場時間物理下限
    
    formulas:
      # [Spec 4.1] 時間下限修正 (團隊屬性)
      time_reduction: ['ath_speed', 'talent_offiq', 'off_pass'] # 這些屬性越高，進攻時間下限越低
      
      # [Spec 4.2] 空間與跑位
      spacing_off: ['off_move', 'talent_offiq'] # 進攻方製造空間的屬性
      spacing_def: ['off_move', 'talent_defiq'] # 防守方壓縮空間的屬性
      
      # [New v2.4] 前場速度折扣計算用 (5人)
      frontcourt_speed: ['ath_speed']

    # [Spec v1.4 Section 4.3] 封蓋判定
    block:
      params:
        base_prob: 0.01             # 基礎封蓋觸發率 (1%)
        spacing_penalty_prob: 0.05  # 當空間擁擠(<0)時，額外增加的封蓋率 (5%)
      formulas:
        # 階段一: 觸發 (能否摸到球)
        trigger_off: ['off_move']                    # 進攻跑位越高，越難被封蓋
        trigger_def: ['def_contest', 'talent_defiq'] # 防守干擾越高，越容易觸發封蓋
        # 階段二: 對抗 (Power Ratio - 硬碰硬)
        power_off: ['ath_strength', 'ath_jump', 'talent_offiq', 'height']
        power_def: ['ath_strength', 'ath_jump', 'def_contest', 'talent_defiq', 'height']

    # [Spec v1.4 Section 4.4] 前場抄截
    steal:
      params:
        base_prob: 0.01          # 基礎前場抄截率 (1%)
        stat_diff_coeff: 0.001   # 機率加成係數 (0.1%)
      formulas:
        off_attr: ['off_dribble', 'off_handle', 'off_pass', 'talent_offiq', '-height']      # 持球者的護球屬性
        def_attr: ['ath_speed', 'def_disrupt', 'talent_defiq', '-height']   # 防守者的抄截屬性

  # === 投籃與結算 (Shooting & Scoring) [Spec v2.1 Section 5] ===
  shooting:
    params:
      base_rate_2pt: 0.40         # [Spec 5.1] 兩分球基礎命中率 (40%) - v1.7
      base_rate_3pt: 0.20         # [Spec 5.1] 三分球基礎命中率 (20%) - v1.7
      spacing_weight: 0.1         # 空間加成係數 (公式中的 * 0.1)
      assist_prob_coeff: 0.1      # [Spec 5.5] 助攻機率係數 (公式中的 * 0.1)
      multiplier_3pt: 1.2         # [Spec 5.2.A] 3分球特殊加成倍率
      
      # [New] 技巧加成參數
      # 公式: * (1 + (屬性總和 / divisor))
      skill_bonus_divisor: 800.0 
    
    formulas:
      # [Spec 5.2.A] 命中率總和 (包含 height)
      off_total: 'off_14'         # 引用 attr_pools.off_14 (含 height)
      def_total: 'def_12_with_height' # 引用 attr_pools.def_12_with_height
      
      # [New] 技巧加成屬性池
      # 定義哪些屬性會影響基礎命中率的額外加成
      skill_bonus_attrs: ['shot_accuracy', 'shot_range', 'off_move']
      
      # 3分球特殊加成屬性 (這些屬性在3分判定時會 x multiplier_3pt)
      bonus_3pt_attrs: ['shot_accuracy', 'shot_range', 'off_move']
      
      # [Spec 5.2] 犯規判定 (IQ vs IQ)
      foul_off_iq: ['talent_offiq']
      foul_def_iq: ['talent_defiq']
      
      # [Spec 5.3] 三分球判定
      range_attr: ['shot_range']  # 射程越高，三分球機率越高

    # [Spec v1.4 Section 5.4] 籃板判定
    rebound:
      params:
        def_base_rate: 0.10       # 防守籃板基礎優勢 (10%)
      formulas:
        off_attr: ['talent_offiq', 'def_rebound', 'def_boxout', 'height'] # 進攻籃板屬性
        def_attr: ['talent_defiq', 'def_rebound', 'def_boxout', 'height'] # 防守籃板屬性

    # [Spec v1.4 Section 5.2 & 5.3] 罰球
    ft:
      params:
        base_min: 0.40            # 罰球基礎命中率下限
        base_max: 0.95            # 罰球基礎命中率上限
        attr_coeff: 0.0001        # 屬性修正係數 (100點屬性約 +1%)
      formulas:
        bonus_attrs: ['talent_luck', 'shot_touch'] # 罰球看運氣與手感

    # [Spec v1.4 Section 5.5] 助攻
    assist:
      formulas:
        team_stat: ['talent_offiq', 'off_handle', 'off_pass', 'off_move'] # 判定是否發生助攻的團隊屬性
        luck_stat: ['talent_luck']                                         # 影響助攻係數的運氣屬性
        distribution: ['off_handle', 'off_pass']                           # 用於決定是誰傳出助攻的權重

  # === 數據歸屬權重 (Data Attribution) [Spec v1.4 Section 6] ===
  attribution:
    params:
      shot_star_bonus: 1.5        # Star 球員出手權重加成 (1.5倍)
      shot_starter_bonus: 1.2     # Starter 球員出手權重加成 (1.2倍)
      rebound_height_weight: 1.5  # 身高/彈跳/籃板/卡位的加權倍率 (1.5倍)
    
    formulas:
      # [Spec 6.1] 投籃歸屬 (引用 Off_Total, 額外加成由程式邏輯判斷 3分/2分)
      shot_weight_base: 'off_14'  # 基礎出手權重看進攻總值
      shot_3pt_bonus: ['shot_release', 'shot_range', 'off_move'] # 若是三分球回合，這些屬性權重加倍

      # [Spec 6.3] 籃板歸屬
      rebound_base: ['ath_strength', 'ath_speed', 'off_move']    # 基礎權重
      rebound_bonus: ['ath_jump', 'def_rebound', 'def_boxout']   # 加權權重 (會乘上 height_weight)
      rebound_iq_off: ['talent_offiq']                           # 進攻籃板額外看 IQ
      rebound_iq_def: ['talent_defiq']                           # 防守籃板額外看 IQ

      # [Spec 6.4] 助攻歸屬
      assist_weight: ['off_handle', 'off_pass', 'talent_offiq']  # 誰最容易拿到助攻

      # [Spec 6.5] 抄截歸屬
      steal_weight: ['def_disrupt', 'talent_defiq', 'ath_speed', 'def_contest'] # 誰最容易拿到抄截
      
# =============================================================================
# 4. 戰術與陣容設定 (Tactics & Roster)
# 對應規格書: ASBL Tactics & Roster Specification v1.2
# =============================================================================
tactics_system:
  roster_size: 15 # 登錄名單固定人數
  
  # 角色階層限制 (Cumulative Constraints)
  # 檢查邏輯: 累計該階層包含的角色數量，不可超過 max
  constraints:
    tier_1:
      max: 3
      roles: ["Star"]
      desc: "核心巨星上限"
    
    tier_2:
      max: 5
      roles: ["Star", "Starter"]
      desc: "主力陣容上限"
    
    tier_3:
      max: 12
      roles: ["Star", "Starter", "Rotation", "Role"]
      desc: "主要輪替上限"
      
    # Tier 4 是隱性規則: 剩餘名額必須由 Bench 填補 (或系統生成的幽靈球員)

  # 自動填補設定 (Auto-Fill)
  auto_fill:
    sort_by: "rating" # 優先順序依據 (attr_sum)
    
    # 緊急填補機制 (Phantom Players)
    emergency:
      enabled: true
      trigger_threshold: 15 # 若名單少於此數則觸發
      phantom_player:
        grade: "G"
        role: "Bench"
        save_to_db: false # 不存入資料庫
        record_stats: false # 不記錄生涯數據
      
# =============================================================================
# 5. 球探設定 (Scout System)
# =============================================================================
scout_system:
  cost_per_level: 1000      # 每日球探費用倍率 (1000 * n)
  max_level: 10             # 最大投入等級
  pending_expire_days: 7    # 待簽名單保留天數
  inactive_team_days: 7     # 球隊未登入判定天數 (超過則清空待簽名單)

# =============================================================================
# 6. AI 卡牌生成設定 (AI Card Generation) - [Spec v5.0]
# =============================================================================
ai_card_generation:
  # API 連線設定
  connection:
    provider: "sd_webui"
    base_url: "http://127.0.0.1:7860"

  output:
    directory: "frontend/public/assets/cards"
    filename_pattern: "player_{id}.png" # 支援 {id} 佔位符

  # 模型設定
  model:
    checkpoint: "JANKUTrainedNoobaiRouwei_v69.safetensors"
    loras:
      - name: "CharacterDesign-IZT-V1"
        filename: "CharacterDesign-IZT-V1.safetensors"
        trigger_word: "CharacterDesignIZT"
        weight: 0.8

  # 生成參數
  params:
    width: 768
    height: 1024
    steps: 28
    cfg_scale: 7.0
    sampler_name: "Euler a"
    clip_skip: 2

  # 提示詞模板
  prompts:
    positive_base: >-
      (score_9, score_8_up, masterpiece, best quality, source_anime),
      (anthropomorphic chibi cat:1.2), full body,
      CharacterDesignIZT, <lora:CharacterDesign-IZT-V1:0.8>
    
    negative_base: >-
      score_6, score_5, score_4,
      text, logo, watermark, signature, jersey number, numbers, letters,
      basketball hoop, net, bleachers, crowd, stadium, audience,
      human face, human skin, bad anatomy, missing limbs, extra digits,
      crutches, wheelchair, cast,
      cropped, cut off, out of frame, blurry, lowres

  # =========================================================
  # 規則映射表 (Mappings) - Spec v5.0 Full Implementation
  # =========================================================
  mappings:
    # 1. 動作權重池 (Stat-Driven Actions)
    # 程式邏輯: 遍歷列表，若球員屬性 >= min，則將該動作加入隨機池 (權重為 weight)
    actions:
      pool:
        - condition: {attr: "off_dribble", min: 80}
          code: "crossover"
          weight: 50
          prompt: "dynamic crossover dribble, body leaning, ball switching hands"
        
        - condition: {attr: "off_dribble", min: 80}
          code: "dribble_low"
          weight: 30
          prompt: "dribbling basketball, low stance, intense focus"
        
        - condition: {attr: "shot_accuracy", min: 80}
          code: "fadeaway"
          weight: 50
          prompt: "fadeaway shot, leaning back, one leg raised"
        
        - condition: {attr: "shot_accuracy", min: 80}
          code: "jump_shot"
          weight: 30
          prompt: "jumping high, shooting form, ball above head, mid-air"
        
        - condition: {attr: "ath_jump", min: 80}
          code: "dunk_tomahawk"
          weight: 50
          prompt: "one-handed tomahawk dunk pose, arm extended back"
        
        - condition: {attr: "ath_jump", min: 80}
          code: "dunk_power"
          weight: 30
          prompt: "two-handed slam dunk pose, hanging in air, legs bent"
        
        - condition: {attr: "def_rebound", min: 80}
          code: "rebound_reach"
          weight: 50
          prompt: "reaching high with both hands, jumping vertical, catching ball"
        
        - condition: {attr: "def_disrupt", min: 80}
          code: "defense_stance"
          weight: 40
          prompt: "defensive stance, arms spread wide, knees bent"
        
        - condition: {attr: "off_pass", min: 80}
          code: "no_look_pass"
          weight: 40
          prompt: "looking away, passing basketball with both hands"
        
        # 基礎動作 (無條件，所有球員皆有)
        - condition: null 
          code: "holding_ball_hip"
          weight: 10
          prompt: "holding basketball at hip, confident stance"
        
        - condition: null
          code: "finger_spin"
          weight: 5
          prompt: "spinning basketball on finger, playful expression"

    # 2. 稀有度特效字典 (Rarity FX)
    rarity_fx:
      G: "matte flat background, desaturated color, no particles, simple paper texture"
      C: "clean solid color background, minimal geometric shapes, soft lighting"
      B: "gradient background, layered geometry, subtle rim light"
      A: "neon glowing lines, tech grid, vivid contrast, spotlight"
      S: "dynamic speed lines, motion blur, strong backlight, energy streaks"
      SS: "floating light particles, holographic shards, intense bloom, cinematic lighting"
      SSR: "golden divine aura, iridescent refraction, complex fractal geometry, god rays, masterpiece"

    # 3. 連續性特徵映射 (Continuous Traits)
    # 邏輯: weight = base + (value - ref_val) * coeff
    continuous_traits:
      height:
        base: 1.0
        ref_val: 195
        coeff: 0.015
        prompt_fmt: "(tall stature:{w:.2f}), (long legs:{w:.2f})"
      
      strength:
        base: 0.8
        ref_val: 0 # Strength 直接乘係數 (0.8 + S * 0.006)
        coeff: 0.006
        prompt_fmt: "(muscular build:{w:.2f}), (broad shoulders:{w:.2f})"
      
      speed:
        base: 0.5
        ref_val: 0
        coeff: 0.01
        prompt_fmt: "(wind blowing fur:{w:.2f}), (dynamic motion:{w:.2f})"
      
      jump:
        base: 0.8
        ref_val: 0
        coeff: 0.008
        prompt_fmt: "(feet off ground:{w:.2f}), (mid-air suspension:{w:.2f})"

    # 4. 年齡映射 (Age)
    # 邏輯: 依據年齡計算 young 與 old 的權重
    age_traits:
      base_age: 18
      young_base: 1.3
      young_coeff: -0.03
      old_base: 0.8
      old_coeff: 0.03
      prompt_fmt: "(young cute face:{w_young:.2f}), (mature serious expression:{w_old:.2f})"

    # 5. 狀態與健康 (Status)
    status_traits:
      stamina:
        high:
          threshold: 80
          prompt: "(energetic expression:1.2), (sparkles around:0.8)"
        low:
          threshold: 40
          prompt: "(sweating:1.2), (heavy breathing:1.0), (tired expression:1.0)"
      
      health:
        low:
          threshold: 50
          prompt: "(bandages on legs:1.3), (kinesiology tape on shoulder:1.2), (athletic tape:1.2)"
        high:
          threshold: 80
          prompt: "(pristine condition:1.1)"