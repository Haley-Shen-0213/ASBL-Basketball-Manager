# ASBL 比賽引擎規格書 (v2.4) ASBL_Match_Engine_Specification.md

**版本**：2.4
**狀態**：已確認 (Confirmed)
**最後更新**2026-01-23
**變更記錄**：
*   **v1.0 (2025-12-04)**：初始版本
*   **v1.2 (2025-12-07)**：體力消耗公式係數調整、基礎命中率調整 (Base Shooting Percentage)
*   **v1.3 (2025-12-07)**：再度調整體力消耗公式係數
*   **v1.4 (2025-12-07)**：新增數據歸屬判定機制 (Data Attribution)，定義球員個人數據分配邏輯。
*   **v1.5 (2025-12-13)**：新增犯規離場規則 (6犯)，定義犯滿後的上場時間重分配機制。
*   **v1.6 (2025-12-16)**：新增開場跳球機制、節次球權輪替規則 (Q2/Q3負方, Q4勝方)、首回合強制後場時間。
*   **v1.7 (2025-12-20)**：修正三分球基礎命中率。
*   **v1.8 (2025-12-20)**：重構投籃結算流程 (Section 5)，調整判定順序為：類型判定 -> 命中計算 -> 犯規判定；**新增輸出數據定義 (Section 7)**。
*   **v2.1 (2025-12-28)**：
    *   **新增**: 賽前身高修正機制 (Height Correction)。
    *   **調整**: 體力系統引入「年齡衰退」參數 (20歲/1%)；中場與節間休息改為時間恢復制。
    *   **調整**: 後場事件 (Backcourt) 引入身高懲罰。
    *   **調整**: 前場封蓋 (Block) 雙方皆受身高加成。
    *   **調整**: 前場抄截 (Steal) 雙方皆受身高懲罰，防守方新增「跑位」 `off_move`。
    *   **調整**: 投籃判定 (Shooting) 引入身高加成；三分球加權 `shot_accuracy` 與 `shot_range`；防守方移除 `def_rebound`。
    *   **調整**: 籃板判定 (Rebound) 雙方皆受身高加成。
    *   **優化**: 全文屬性名稱統一為 Config Key 格式。
*   **v2.2 (2026-01-07)**：
    *   **新增**: 投籃命中率公式加入 **技巧加成 (Skill Bonus)** 機制，公式為 `1 + (accuracy+range+off_move)/800`，強化高數值射手優勢，並且將三分加成同步加上 `off_move`。
*   **v2.3 (2026-01-07)**：
    *   **新增**: 抄截後的攻守轉換。
*   **v2.4 (2026-01-23)**：
    *   **調整**: 後場時間計算加入 **速度折扣 (Speed Discount)** 機制。
    *   **新增**: 後場 **8秒違例** 判定規則。
    *   **調整**: 前場時間計算加入 **速度折扣 (Speed Discount)** 機制。
    *   **新增**: 全場 **24秒違例** 判定規則。
    *   **更新**: Section 7 輸出數據定義，補全 Pace、快攻、+/- 值與進階團隊數據。

---

## 0. 全域規則 (General Rules)
*   **數值引用**: 引擎中所有涉及屬性的計算 (命中、對抗、判定)，皆必須使用經由 **體力衰退修正後** 的「當前能力值」。
*   **平手處理**: 若正規時間 (4節) 結束平手，進入延長賽 (OT)。
    *   OT 時間: 5 分鐘。
    *   體力: **不重置** (延續正規賽狀態)。

---

## 1. 賽前準備 (Pre-Game Setup)

### 1.1 位置能力評分 (Positional Scoring)
比賽開始前，系統需針對每位球員計算五個位置的適性分數，用於決定輪替順序。
*   **最強陣容 (Best 5)**: 系統需標記出該隊五個位置分數最高的組合，用於關鍵時刻。

| 位置                | 計算公式 (由高至低排序)                                        |
| :------------------ | :----------------------------------------------------------- |
| **中鋒 (C)**        | 身高 + 力量 + 籃板 + 卡位 + 干擾                               |
| **大前鋒 (PF)**     | 身高 + 力量 + 籃板 + 卡位 + 干擾 + 彈跳 + 速度                  |
| **小前鋒 (SF)**     | **全部 20 項屬性總和 + 身高**                                  |
| **得分後衛 (SG)**   | 手感 + 出手速度 + 進攻智商 + 防守智商 + 干擾 + 抄截 + 射程       |
| **控球後衛 (PG)**   | 速度 + 進攻智商 + 抄截 + 運球 + 控球 + 傳球 - **身高**          |

### 1.2 先發陣容決定邏輯 (Starting Lineup)
系統依據以下優先順序填入先發五人 (PG, SG, SF, PF, C)
填入順序按照**明星**->**先發**->其他(PG, C, SG, SF, PF)：

1.  **明星優先 (Star Priority)**
    *   隊伍中的 `Star` 球員擁有最高優先權。
    *   若有多位 `Star`，依據「位置評分」最高的順位優先鎖定位置。

2.  **先發填補 (Starter Fill)**
    *   `Star` 分配完畢後，由 `Starter` 球員填補剩餘空缺。

3.  **剩餘填補 (Fill Gaps)**
    *   若 5 個位置仍有空缺，由剩餘球員中「該位置評分最高者」填補。

### 1.3 輪替排序 (Rotation Order)
*   非先發球員依據各位置評分高低列入替補名單。
*   實際換人時機由體力系統控制。
*   若球員已達時間上限，非必要不上場

### 1.4 比賽時間分配規則補充 (Minutes Distribution)
系統需將 240 分鐘分配給登錄球員，作為換人參考。
*   **分配演算法**: `個人時間 = 保底時間 + (權重 * 單位時間價值)`。
*   **角色參數**:
    *   **Star**: 保底 30min, 權重 -1~5。
    *   **Starter**: 保底 20min, 權重 -2~7。
    *   **Rotation**: 保底 10min, 權重 5~15。
    *   **Role**: 保底 0min, 權重 5~12。
    *   **Bench**: 保底 0min, 權重 0~10。
*   **計算邏輯**:
    1.  扣除總保底時間，剩餘時間依權重比例分配。
    2.  計算結果無條件捨去至小數點第一位。
    3.  尾數誤差補給最後一位球員。

### 1.5 身高屬性修正 (Initial Height Correction) [New v2.1]
在比賽載入階段，針對特定屬性進行基於身高的物理修正。此修正為「永久性修正」(針對該場比賽)，先於體力修正計算。

*   **修正公式**:
    `修正屬性 = 修正屬性 * (1+(max(BONUS_H - hight,min(NERF_H - hight, 0))) * Coeff`

*   **參數設定 (Parameters)**:
    *   `BONUS_H` (矮個加成閾值): **190** (cm)
    *   `NERF_H` (高個減益閾值): **210** (cm)
    *   **受影響屬性與係數 (Coeff)**:
        *   `速度 (ath_speed)`, `運球 (off_dribble)`: **0.02**
        *   `控球 (off_handle)`, `抄截 (def_disrupt)`: **0.01**

### 1.6 開場跳球與球權輪替 (Jump Ball & Possession) [New v1.6]
決定比賽開始的球權歸屬以及各節次的開球方。

*   **跳球參與者 (Participants)**:
    *   兩隊分別選出 **(身高 + 彈跳 + 進攻智商)** 總和最高的球員代表跳球。
*   **獲勝判定 (Winning Logic)**:
    *   計算兩位參與者的數值總和 (Score_Home, Score_Away)。
    *   **獲勝機率**: `P(Home) = Score_Home / (Score_Home + Score_Away)`。
    *   系統依據此機率隨機決定跳球獲勝方 (Winner)。
*   **節次球權歸屬 (Quarter Possession)**:
    *   **第 1 節 (Q1)**: **跳球獲勝方** 獲得球權。
    *   **第 2 節 (Q2)**: **跳球失敗方** 獲得球權。
    *   **第 3 節 (Q3)**: **跳球失敗方** 獲得球權。
    *   **第 4 節 (Q4)**: **跳球獲勝方** 獲得球權。
    *   **延長賽 (OT)**: 重新跳球 (規則同 Q1)。

---

## 2. 體力系統 (Stamina System)

### 2.1 基礎參數
*   **初始體力**: 100 (每場比賽重置)。
*   **中場回復**: 移除固定增加，改由體力恢復章節回復。 **[New v2.1]**
*   **換人門檻**: 當場上球員體力 **< 80** 時，觸發換人檢查。

### 2.2 能力值動態修正 (Dynamic Nerf)
體力下降會直接削弱球員當下的能力值。

| 當前體力   | 修正係數 (Multiplier)        | 說明                                               |
| :--------- | :--------------------------- | :----------------------------------------------- |
| **80~100** | **1.0x** (100%)              | 狀態良好，無影響。                                 |
| **< 80**   | **1.0 - (80-體力)*0.01**     | 線性衰退 (例: 70體力=90%能力; 40體力=60%能力)。     |
| **1**      | **0.21x** (21%)              | 極限狀態，能力值僅剩 21%。                         |

### 2.3 體力消耗 (Drain) - *上場時*
*   **公式**: `消耗量/分 = (3.0 * (1 + (1 - 體能%) + (1 - 健康%))) * ((1 + (Age - AGE_THRESHOLD)) * AGE_DECAY_RATE)` 
        **(V1.2 從2.0增加至2.5，V1.3從2.5增加至3.0，v2.1增加年齡修正)**
*   **變數轉換**:
    *   `體能%`: 屬性 `ath_stamina` (1~99 轉為 0.01~0.99)。
    *   `健康%`: 屬性 `talent_health` (1~99 轉為 0.01~0.99)。
    *   `AGE_THRESHOLD` (衰退起始年齡): **20**        **[New v2.1]**
    *   `AGE_DECAY_RATE` (衰退係數): **0.01**         **[New v2.1]**
*   **模型驗證 (以健康 60 為例)**:
    *   **體能 10 (差)**: 每分鐘消耗約 **3.75** (上場約 5.3 分鐘開始衰退)。
    *   **體能 60 (中)**: 每分鐘消耗約 **3.20** (上場約 6.2 分鐘開始衰退)。
    *   **體能 99 (優)**: 每分鐘消耗約 **2.42** (上場約 8.2 分鐘開始衰退)。

### 2.4 體力恢復 (Recovery) - *板凳時*
*   **公式**: `恢復量/分 = (1.0 + (體能%) - (1 - 健康%)) * ((1 - (Age - AGE_THRESHOLD)) * AGE_DECAY_RATE)`
            **[New v2.1 增加年齡修正]**
*   **邏輯**: 體能越好、健康越好，體力回得越快。
*   **模型驗證 (以健康 60 為例)**:
    *   **體能 10**: 每分鐘恢復 **0.7**。
    *   **體能 60**: 每分鐘恢復 **1.2**。
    *   **體能 99**: 每分鐘恢復 **1.59**。
*   **休息事件恢復 [New v2.1]**:
    *   **節與節之間 (Quarter Break)**: 模擬休息 **2 分鐘**。
        *   `Recovery = 恢復率 * 2.0`
    *   **中場休息 (Halftime)**: 模擬休息 **20 分鐘**。
        *   `Recovery = 恢復率 * 20.0`
*   **限制**: 體力值最低為 1，上限為 100。

### 2.5 換人執行 (Substitution Execution)
比賽進行中，依據以下優先順序執行換人：

1.  **關鍵時刻強制調度 (Clutch Override)**
    *   **時機**: 第 4 節最後 2 分鐘 (剩餘時間 <= 2:00) 及 延長賽 (OT) 最後 2 分鐘 (剩餘時間 <= 2:00)。
                **[New v2.1 修正]**
    *   **執行**: **強制換上「最強陣容 (Best 5)」**。
    *   *例外*: 除非該球員犯滿離場或受傷，否則無視體力狀況與時間限制。

2.  **常規換人 (Regular Rotation)**
    *   **觸發條件**:
        *   場上球員體力 **< 80**。
        *   或 場上球員已超過「目標上場時間」。
    *   **替補選擇**:
        *   選擇同位置中「體力 > 場上球員」且「未達時間上限」能力最強者。

#### **2.6 犯規與離場 (Fouls & Disqualification)**
*   **個人犯規上限**: 每位球員單場比賽累計犯規次數達到 **6 次** 時，即判定為「犯滿離場 (Fouled Out)」。
*   **離場處置**:
    *   該球員必須立即被替換下場。
    *   該球員在剩餘比賽時間內（含延長賽）不得再次上場。
*   **時間重分配 (Time Redistribution)**:
    *   當球員離場後，其剩餘的「目標上場時間」需分配給其他隊友，以確保比賽能順利進行。
    *   **分配邏輯**:
        1.  系統依序檢查 C -> PF -> SF -> SG -> PG 五個位置。
        2.  每個位置選出「位置評分」最高的前 3 名球員 (排除已離場者)。
        3.  將離場球員的剩餘時間，平均分配給這 15 個名額 (若球員同時是多個位置的前 3 名，則獲得多份時間)。
        4.  *公式*: `每份時間 = 離場者剩餘時間 / 15`。

## 3. 比賽引擎：後場階段 (Backcourt Phase)

### 3.1 基礎設定
*   **參與者**:
    *   **進攻方**: PG + SG + 隨機 1 名球員 (共 3 人)。
    *   **防守方**: 對應的 3 名防守者。
*   **屬性池**: **[New v2.1 增加身高修正]**
    *   `進攻總值 (Off_Sum)` = 3 人的 (運球 + 傳球 + 進攻智商 - 身高) 總和。
    *   `防守總值 (Def_Sum)` = 3 人的 (抄截 + 干擾 + 防守智商 - 身高) 總和。
    *   `後場速度總值 (Backcourt_Speed_Sum)` = 進攻方 3 人的 `速度 (ath_speed)` 總和。 **[New v2.4]**

### 3.2 時間計算 (Time Calculation) [Update v2.4]
1.  **基礎時間**: 隨機骰 **1.0 ~ 8.0** 秒 (取至小數點第一位)。
2.  **對抗修正**:
    *   `對抗修正秒數 = (Def_Sum - Off_Sum) * 0.008`
3.  **速度折扣 (Speed Discount)**:
    *   `折扣秒數 = Random(0, (Backcourt_Speed_Sum / 3) * 0.01)`
    *   *說明*: 速度越快，隨機扣除的時間越多，使推進更迅速。
4.  **最終時間**: `基礎時間 + 對抗修正秒數 - 折扣秒數`。
    *   **下限**: 鎖定在 **0.5** 秒 (物理極限)。

### 3.3 事件判定
根據 `最終時間` 觸發對應事件：

| 最終時間     | 觸發事件     | 判定邏輯                |
| :----------- | :----------- | :---------------------- |
| **> 8.0 秒** | **8秒違例**  | 進攻方失誤，球權轉換。  |
| **> 3.0 秒** | **抄截判定** | 進入抄截檢定 (見 3.4)。 |
| **1.0 ~ 3.0**| **正常推進** | 安全過半場。            |
| **< 1.0 秒** | **快攻**     | 進入快攻檢定 (見 3.5)。 |

### 3.4 抄截判定 (Backcourt Steal)
*   **基礎機率**: **1%**。
*   **機率加成**: `(Def_Sum - Off_Sum) * 0.1%`。
*   **結算**: 骰 `1-100` <= 最終機率則失誤。

### 3.4.1 抄截後的攻守轉換 (Transition after Steal) [Update v2.3]

當後場抄截判定成功時，系統需判定是發動「轉換快攻」還是進入「前場陣地戰」。

*   **觸發條件**: `3.4` 抄截判定成功。
*   **轉換快攻判定公式**:
    *   **屬性定義**: 取雙方 **場上5人** 的 `速度 (ath_speed)` 總和。
    *   **機率**: `50% + (原守方速度總和 - 原攻方速度總和) / 原攻方速度總和`。
    *   *說明*: 若防守方整體速度快於進攻方，快攻機率提升；反之則傾向穩紮穩打。
*   **流程分支**:
    1.  **判定通過 (Fastbreak)**:
        *   立即執行 **3.5 快攻判定**。
        *   攻守角色互換 (原守方變進攻方)。
    2.  **判定失敗 (Set Play)**:
        *   **跳過後場階段**，直接進入 **4. 前場階段**。
        *   攻守角色互換 (原守方變進攻方)。
        *   *說明*: 模擬抄截後對方快速回防，雖未形成快攻，但已推進至前場。

### 3.5 快攻判定 (Fastbreak)
當推進極快時觸發，由雙方「跑最快」的球員進行 1v1 綜合能力對決。

#### A. 參與者屬性計算 **[New v2.1 增加投籃技巧修正]**
*   **進攻者 (Off)**: 取場上 `(速度 + 運球)` 最高者。
    *   `Off_Stat` = 力量 + 速度 + 彈跳 + 手感 + 出手速度 + 進攻智商 + 運氣 + 跑位 + 運球 + 投籃技巧
*   **防守者 (Def)**: 取場上 `(速度 + 防守智商)` 最高者。
    *   `Def_Stat` = 力量 + 速度 + 彈跳 + 手感 + 出手速度 + 防守智商 + 運氣 + 干擾 + 抄截 + 投籃技巧

#### B. 進球成功率 (Success Rate)
*   **基礎成功率 (Base)**: 隨機產生 **0.3 ~ 1.0** (30% ~ 100%)。
    *   *代表快攻當下的混亂程度與機會好壞。*
*   **屬性修正**: `(Off_Stat - Def_Stat) * 0.5%`。
*   **最終成功率**: `Base + 屬性修正` (上限 100%)。
*   **進球判定**: 骰 `1-100` <= 最終成功率 -> **進球**。

#### C. 犯規判定 (Foul Check)
無論是否進球，皆需進行犯規檢定。
*   **核心屬性**: `進攻智商 (Off_IQ)` vs `防守智商 (Def_IQ)`。
*   **犯規機率**: `1% + (Off_IQ - Def_IQ) * 1%`。
    *   *說明*: 基礎 1%，智商每高對手 1 點，多 1% 要到犯規機率。
    *   *下限*: 最低 0.1%。
*   **犯規判定**: 骰 `0-100` <= 犯規機率 -> **觸發犯規**。

#### D. 最終結果結算 (Outcome)
| 進球判定 | 犯規判定 | 結果描述 | 得分 | 後續 |
| :--- | :--- | :--- | :--- | :--- |
| **成功** | **無** | **快攻得分** | +2 | 攻守交換 |
| **成功** | **有** | **進算加罰 (And-1)** | +2 | 執行 1 次罰球 |
| **失敗** | **有** | **阻擋/打手犯規** | 0 | 執行 2 次罰球 |
| **失敗** | **無** | **防守成功** | 0 | 攻守交換 (視為籃板/火鍋) |

## 4. 比賽引擎：前場階段 (Frontcourt Phase)

### 4.1 進攻時間與出手品質 [Update v2.4]
*   **基礎時間範圍**: `8.0` ~ `上限` 秒。
    *   **上限**: 一般回合為 `24.0 - 後場花費時間`；前場籃板回合為 `14.0`。
*   **時間下限修正**:
    *   **影響屬性**: `速度`, `進攻智商`, `傳球`。
    *   **邏輯**: 團隊上述三項屬性越高，能降低時間花費的下限 (最低不低於 4.0 秒)。
*   **初步花費時間**: 在 `修正後下限` 與 `上限` 之間隨機產生。
*   **速度折扣 (Speed Discount)**:
    *   `前場速度總值 (Frontcourt_Speed_Sum)` = 進攻方場上 5 人的 `速度 (ath_speed)` 總和。
    *   `折扣秒數 = Random(0, (Frontcourt_Speed_Sum / 5) * 0.01)`
    *   **實際花費時間** = `初步花費時間 - 折扣秒數`。
    *   **下限**: 實際花費時間最低不低於 **1.0** 秒。
*   **24秒違例判定**:
    *   若 `後場時間 + 實際花費時間 > 24.0`，則判定為 **24秒違例** (Team Turnover)，球權轉換。
*   **出手品質加成**:
    *   時間花費越少 -> 出手品質加成越高。
    *   公式：`時間加成 = (7 - 實際花費時間) * 0.01`。

### 4.2 空間與跑位 (Spacing)
*   **影響屬性**:
    *   **進攻方 (Off_Sum)**: `跑位` (可訓練) + `進攻智商` (不可訓練)。
    *   **防守方 (Def_Sum)**: `跑位` (可訓練) + `防守智商` (不可訓練)。
*   **空間加成係數 (Spacing Bonus)**:
    *   **公式**: `(Off_Sum - Def_Sum) / Def_Sum`，以25%為下限、125%為上限，隨機產生。
    *   **上限**: 最大值為 **1.0**。
*   **空間效果判定**:
    *   **加成 > 0.5**: **完全空檔 (Wide Open)**，封蓋不會發生 (機率 = 0%)。
    *   **加成 < 0**: **空間擁擠**，增加被封蓋的機率。
    *   **一般情況 (0 ~ 0.5)**: 正常計算封蓋機率。

### 4.3 防守事件：封蓋 (Block)
封蓋判定分為兩個階段：**觸發判定** 與 **對抗判定**。

#### 階段一：觸發判定 (Attempt Check)
決定防守者是否能跟上並嘗試封蓋。
*   **前提**: 若 `空間加成 > 0.5`，此階段直接失敗 (無法封蓋)。
*   **基礎機率**: **1%**。
*   **機率修正**:
    *   **降低**: 進攻方 `跑位`。
    *   **提升**: 防守方 `干擾` + `防守智商`。
    *   **空間懲罰**: 若 `空間加成 < 0`，額外大幅提升觸發機率。
*   **結果**: 若判定通過，進入階段二；否則無封蓋。

#### 階段二：對抗判定 (Success Check)
決定是「成功蓋火鍋」還是「進攻方強行出手/灌籃」。
*   **對抗公式**: **[New v2.1 增加身高修正]**
    *   `進攻力 (Off_Power)` = 力量 + 彈跳 + 進攻智商 + 身高
    *   `防守力 (Def_Power)` = 力量 + 彈跳 + 干擾 + 防守智商 + 身高
    *   **判定標準 (Ratio)** = `Off_Power / Def_Power`
*   **結算邏輯**:
    *   **Ratio 數值越低**: 防守方優勢越大 -> **封蓋成功 (Block)**。
    *   **Ratio 數值越高**: 進攻方優勢越大 -> **封蓋失敗** (可能轉為犯規或強行進球)。

### 4.4 防守事件：抄截 (Steal)
*   **基礎機率**: **1%**。
*   **影響屬性**: **[New v2.1 增加身高、智商、跑位修正]**
    *   **進攻方 (Off_Ball)**: `運球` + `控球` + `傳球` - `身高` + `進攻智商` 。
    *   **防守方 (Def_Steal)**: `速度` (不可訓練) + `抄截` (可訓練) + `防守智商` (不可訓練) - `身高` + `跑位` (可訓練)。
*   **判定流程**:
    *   計算雙方屬性差值。
    *   **最終機率** = `1% + (Def_Steal - Off_Ball) * 係數`。
    *   骰 `1-100` <= 最終機率 -> **抄截成功 (Turnover)**。

## 5. 比賽引擎：投籃命中與結算 (Shooting & Scoring) **(v1.8 重構投籃判定機制)**

### 5.1 投籃類型判定 (Shot Type Determination)
若前場階段未發生失誤或被封蓋，首先決定這是一記 2 分球還是 3 分球。

*   **閾值計算**: `Threshold = 1 / (進攻方射程總和 / 100)`。
*   **判定**: 骰一個隨機數 `R` (0.0 ~ 1.0)。
    *   若 `R > Threshold`: **+3 分** (三分球)。
    *   若 `R <= Threshold`: **+2 分** (兩分球)。
*   *邏輯驗證*: 射程越高 -> Threshold 越小 -> R 大於它的機率越高 -> 越容易是三分。
*   **輸出**: 決定本回合的 **基礎命中率 (Base Rate)**。 **(v1.7 新增三分球)**
    *   **兩分球**: **40%**
    *   **三分球**: **20%**

### 5.2 命中率判定 (Hit Rate Calculation)
依據投籃類型與雙方屬性計算最終命中率。

#### A. 屬性池定義 **[New v2.1 增加身高、三分球加成修正]**
*   **進攻方總和 (Off_Total)**:
    *   `力量` + `速度` + `彈跳` + `手感` + `出手速度` + `進攻智商` + `運氣` + `投籃技巧` + `射程` + `跑位` + `運球` + `傳球` + `控球` + `身高` (共 14 項)。
    *   **3分球特殊加成**: 若判定為 3分球，則 `shot_accuracy` 、 `shot_range` 與 `off_move` 的數值 **x 2** 計算。
*   **防守方總和 (Def_Total)**:
    *   `力量` + `速度` + `彈跳` + `手感` + `出手速度` + `防守智商` + `運氣` + `身高` + `卡位` + `干擾` + `抄截` + `跑位` (共 12 項)。

#### B. 技巧加成 (Skill Bonus) [New v2.2]
針對出手者個人能力進行額外修正，使高數值射手更具優勢。
*   **公式**: `Skill_Bonus = 1 + (出手者.shot_accuracy + 出手者.shot_range + 出手者.off_move) / 800`
*   *說明*: 三項屬性滿值 (99+99+99) 約提供 1.37 倍率；屬性和 100 約提供 1.12 倍率。

#### C. 最終計算公式
*   **對抗修正**: `Diff_Mod = (Off_Total - Def_Total) / Def_Total`
*   **命中率**: `(基礎命中率 + Diff_Mod) * Skill_Bonus * (1 + 空間加成*0.1) * (1 + 品質加成)`。
*   **結算**: 骰 `0.0 ~ 1.0` <= 命中率 -> **投籃命中**。

### 5.3 犯規判定 (Foul Check)
無論是否命中，皆需進行犯規檢定。

*   **公式**: `犯規率 = (進攻方 IQ總和 - 防守方 IQ總和) / 防守方 IQ總和`。
*   **結算**: 骰 `0.0 ~ 1.0` <= 犯規率 -> **觸發犯規**。
*   **結果**:
    *   **進球 + 犯規**: And-1 (加罰 1 球)。
    *   **沒進 + 犯規**: 罰球 (依據 5.1 判定罰 2 球或 3 球)。
    *   **沒進 + 沒犯**: 進入籃板判定 (5.4)。
    *   **進球 + 沒犯**: 進入助攻判定 (5.5)。
*   **罰球命中率公式**:
    *   `隨機基數`: 在 **40% ~ 95%** 之間隨機產生一個浮點數。
    *   `屬性加成`: `(罰球者運氣 + 罰球者手感) * 0.01`。
        *   *註: 兩項屬性相加 100 點約提供 +1% 修正。*
        *   *註2: 如果是快攻發生罰球，則罰球者=快攻執行者，若非則罰球者則為團隊總合計算。*
    *   `最終罰球率` = `隨機基數 + 屬性加成`。

### 5.4 籃板判定 (Rebound) **[New v2.1 增加身高加成修正]**
若投籃未中且未犯規，進行籃板爭奪。

#### A. 屬性池定義
*   **進攻方 (Off_Reb_Stat)**: `進攻智商` + `籃板` + `卡位` + `身高`。
*   **防守方 (Def_Reb_Stat)**: `防守智商` + `籃板` + `卡位` + `身高`。

#### B. 防守籃板機率 (Def_Reb_Rate)
*   **公式**: `10% + Def_Reb_Stat / (Off_Reb_Stat + Def_Reb_Stat)`。
*   *說明*: 基礎 10% 優勢 + 雙方屬性佔比。防守方通常佔優。

#### C. 結算
*   骰 `0.0 ~ 1.0` <= 防守籃板機率 -> **防守籃板** (攻守交換)。
*   骰 `0.0 ~ 1.0` > 防守籃板機率 -> **進攻籃板** (進攻方重置時間為 14秒，繼續進攻)。

### 5.5 助攻判定 (Assist) - *僅進球後計算*
*   **A. 助攻發生判定**:
    *   **團隊屬性**: `Team_Stat` = 進攻方 5 人 (`進攻智商`+`控球`+`傳球`+`跑位`) 總和。
    *   **機率**: `(Team_Stat / 助攻係數) * 0.01` (助攻係數 = 1 / 團隊5人幸運總和)。
    *   若判定通過，則該次得分記為助攻。
*   **B. 助攻者分配**:
    *   **權重**: 場上隊友的 (`控球` + `傳球`) 數值。
    *   **分配**: 依權重比例隨機分配給其中一人 ((`控球` + `傳球`) 越高者 機率較高)。

## 6. 數據歸屬判定 (Data Attribution)
當比賽引擎產生事件（如得分、籃板、失誤）時，系統需依據以下規則將數據分配給特定球員。

### 6.1 投籃出手與得分 (FGA, FGM, PTS, 3PA, 3PM)
*   觸發時機: 進入 Spec 5.1 投籃類型判定之前。
*   候選人: 進攻方場上 5 人。
*   權重計算 (Weight):
*   基礎權重: 引用 Spec 5.2.A 之 Off_Total 屬性池 (共13項屬性總和)。
*   特殊加成:
    *   若判定為 3分球回合: 出手速度、射程、跑位 數值 x 2。
    *   若判定為 2分球回合: 無額外屬性加成。
*   戰術加成:
    *   角色為 Star: 最終權重 x 1.5。
    *   角色為 Starter: 最終權重 x 1.2。
*   分配邏輯:
    *   計算場上 5 人權重總和。
    *   計算每人權重佔比 (Weight / Total)。
    *   產生隨機數 R (0.0 ~ 1.0)。
    *   由權重佔比最小的球員開始依次判定，若 R 落在其區間內則選中。
*   結算:
    *   選中者為 出手者 (Shooter)。
    *   若命中: 獲得 PTS, FGM, (3PM)。
    *   無論命中與否: 獲得 FGA, (3PA)。
### 6.2 罰球 (FTA, FTM)
*   觸發時機: Spec 3.5 (快攻犯規) 或 Spec 5.3 (投籃犯規)。
*   歸屬邏輯:
    *   快攻 (Fastbreak): 歸屬於 快攻執行者 (Runner)。
    *   陣地戰 (Set Play): 歸屬於 出手者 (Shooter)。
*   結算: 執行罰球獲得 FTA，罰進獲得 FTM 與 PTS。
### 6.3 籃板球 (REB, OR, DR)
*   觸發時機: Spec 5.4 判定投籃不進且無犯規。
*   候選人:
    *   防守籃板 (DR): 防守方場上 5 人。
    *   進攻籃板 (OR): 進攻方場上 5 人。
    *   權重計算 (Weight):
    *   通用屬性: 力量 + 速度 + 跑位。
    *   加權屬性: 身高 (*1.5) + 彈跳 (*1.5) + 籃板 (*1.5) + 卡位 (*1.5)。
    *   智商屬性: 若為 DR 則加 防守智商；若為 OR 則加 進攻智商。
*   分配邏輯:
    *   計算 5 人權重佔比。
    *   產生隨機數 R (0.0 ~ 1.0)。
    *   由權重佔比最小的球員開始依次判定 (同投籃邏輯)。
### 6.4 助攻 (AST)
*   觸發時機: Spec 5.5 判定「助攻發生」且投籃命中。
*   候選人: 進攻方場上 5 人 (排除出手者)。
*   權重計算 (Weight):
    *   AST_Weight = 控球 + 傳球 + 進攻智商。
*   分配邏輯:
    *   計算候選人權重佔比。
    *   產生隨機數 R (0.0 ~ 1.0)。
    *   固定判定順序: 依序檢查 C -> PF -> SF -> SG -> PG 的累積機率區間。
        說明: 此順序確保在浮點數邊界或同權重下，PG 擁有最後的判定優勢 (通常機率區間最大)。
### 6.5 抄截 (STL)
*   觸發時機: Spec 3.4 (後場) 或 Spec 4.4 (前場) 判定成功。
*   候選人: 防守方場上 5 人。
*   權重計算:
    *   STL_Weight = 抄截 + 防守智商 + 速度 + 干擾。
*   分配邏輯: 計算權重佔比後隨機分配。
### 6.6 封蓋 (BLK)
*   觸發時機: Spec 4.3 判定「封蓋成功」。
*   歸屬邏輯: 直接對位分配。
    *   判定 出手者 (Shooter) 的位置 (例如 PG)。
    *   歸屬於防守方 相同位置 的球員 (防守方的 PG)。
### 6.7 失誤 (TOV)
*   A. 被抄截 (Stolen):
    *   觸發: 發生 STL 事件。
    *   歸屬: 抄截者 (Defender) 的 對位進攻球員 (例如 Defender PG 抄截 -> Offender PG 失誤)。
*   B. 8秒/24秒違例 (Violation):
    *   歸屬: 團隊失誤 (Team TOV)。
    *   說明: 此類失誤計入球隊總失誤數，但不計入任何球員的個人數據。

## 7. 輸出數據定義 (Output Data Definition) [Update v2.4]
比賽引擎執行完畢後，將回傳以下結構化數據。

### 7.1 比賽結果摘要 (Match Result)
*   **資料來源**：`MatchEngine.simulate()` 回傳之 `MatchResult` 物件。

| 欄位名稱 | 類型 | 說明 | 備註 |
| :--- | :---: | :--- | :--- |
| `game_id` | `str` | 比賽識別碼 | |
| `home_score` | `int` | 主隊得分 | |
| `away_score` | `int` | 客隊得分 | |
| `is_ot` | `bool` | 是否延長 | |
| `pace` | `float` | **比賽節奏** | Pace (Possessions / 48min) |
| `home_possessions` | `int` | **主隊回合數** | |
| `away_possessions` | `int` | **客隊回合數** | |
| `home_avg_seconds_per_poss` | `float` | **主隊平均每回合秒數** | |
| `away_avg_seconds_per_poss` | `float` | **客隊平均每回合秒數** | |
| `home_fb_made` | `int` | **主隊快攻進球** | |
| `home_fb_attempt` | `int` | **主隊快攻嘗試** | |
| `away_fb_made` | `int` | **客隊快攻進球** | |
| `away_fb_attempt` | `int` | **客隊快攻嘗試** | |
| `home_violation_8s` | `int` | **主隊8秒違例** | [New v2.4] |
| `home_violation_24s` | `int` | **主隊24秒違例** | [New v2.4] |
| `away_violation_8s` | `int` | **客隊8秒違例** | [New v2.4] |
| `away_violation_24s` | `int` | **客隊24秒違例** | [New v2.4] |

### 7.2 球員統計數據 (Player Statistics / Box Score)
*   **資料來源**：`EnginePlayer` 物件。

| 分類 | 欄位代號 | 名稱 | 說明 |
| :--- | :--- | :--- | :--- |
| **基礎** | `stat_pts` | 得分 | |
| | `stat_reb` | 籃板 | |
| | `stat_ast` | 助攻 | |
| | `stat_stl` | 抄截 | |
| | `stat_blk` | 阻攻 | |
| | `stat_tov` | 失誤 | |
| | `fouls` | 犯規 | |
| | `stat_plus_minus` | **正負值 (+/-)** | 球員在場期間球隊淨勝分 |
| **投籃** | `stat_fgm` / `stat_fga` | 投籃命中/出手 | |
| | `stat_3pm` / `stat_3pa` | 三分命中/出手 | |
| | `stat_ftm` / `stat_fta` | 罰球命中/出手 | |
| **進階** | `stat_orb` / `stat_drb` | 進/防籃板 | |
| | `stat_fb_made` | **快攻進球** | |
| | `stat_fb_attempt` | **快攻嘗試** | |
| | `stat_remaining_stamina` | **剩餘體力** | |
| | `seconds_played` | 上場時間 | |

### 7.3 團隊統計數據 (Team Statistics)
*   **資料來源**：`EngineTeam` 物件。

| 欄位代號 | 名稱 | 說明 |
| :--- | :--- | :--- |
| `score` | 團隊總分 | |
| `stat_tov` | 團隊失誤 | 包含 8秒/24秒違例等非個人失誤 |
| `stat_violation_8s` | **8秒違例** | [New v2.4] 團隊違例計數 |
| `stat_violation_24s` | **24秒違例** | [New v2.4] 團隊違例計數 |
| `stat_possessions` | **總回合數** | |
| `stat_possession_seconds` | **總控球時間** | 單位：秒 |
| `stat_fb_made` | **團隊快攻進球** | |
| `stat_fb_attempt` | **團隊快攻嘗試** | |
